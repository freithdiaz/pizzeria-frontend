<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nissi Pizza - Administracion Dinamica</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Unificar version de Font Awesome con la pagina de domicilio para evitar inconsistencias en los iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="module" src="./js/supabase-client.js?v=4.1"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        /* Support both .show (used in JS) and .active */
        .modal.show,
        .modal.active {
            display: flex !important;
        }

        .modal>div {
            background-color: #1e293b;
            border-radius: 0.5rem;
            padding: 1.5rem;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            z-index: 1001;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3), 0 0 10px rgba(249, 115, 22, 0.3);
            border: 1px solid #334155;
            color: #f1f5f9;
        }

        /* Mejoras para moviles: modales ocupen casi todo el ancho y padding reducido */
        @media (max-width: 640px) {
            .modal>div {
                max-width: 98%;
                margin: 0.5rem;
                padding: 1rem;
                border-radius: 0.5rem;
                max-height: 92vh;
            }

            /* Asegurar que los contenedores principales adaptan su padding */
            .container {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }

            header .flex {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

            .tab-btn {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
                white-space: nowrap;
            }

            nav {
                overflow-x: auto;
            }
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* Mejoras responsivas para tablas y acciones en pantallas pequenas */
        @media (max-width: 640px) {

            /* Tabla de inventario: convertir rows en bloques apilados */
            .overflow-x-auto table,
            .overflow-x-auto thead,
            .overflow-x-auto tbody,
            .overflow-x-auto th,
            .overflow-x-auto td,
            .overflow-x-auto tr {
                display: block;
            }

            .overflow-x-auto thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            .overflow-x-auto tr {
                margin: 0 0 1rem 0;
                border: 1px solid rgba(148, 163, 184, 0.06);
                padding: 0.5rem;
                border-radius: 0.5rem;
                background: rgba(15, 23, 42, 0.6);
            }

            .overflow-x-auto td {
                /* Cada celda se muestra como fila flex con label y valor */
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.5rem 0.5rem;
                text-align: left;
                border: none;
            }

            .overflow-x-auto td::before {
                /* usar el atributo data-label para mostrar el encabezado */
                content: attr(data-label) ': ';
                font-weight: 600;
                color: #94a3b8;
                margin-right: 0.5rem;
            }

            /* Reducir padding en tablas y botones dentro de tarjetas */
            .overflow-x-auto th,
            .overflow-x-auto td {
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
            }

            /* Permitir que los botones de accion dentro de las tarjetas se apilen verticalmente */
            .card-hover .space-x-2 {
                display: flex;
                gap: 0.5rem;
                flex-direction: column;
            }

            /* Ajustes para modales y contenedores mas estrechos */
            .modal>div {
                padding: 0.75rem;
            }
        }
    </style>
    <script src="./js/config.js" defer></script>
</head>

<body class="bg-slate-900 text-white min-h-screen">
    <!-- Header -->
    <header class="bg-slate-800 shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-pizza-slice text-3xl text-yellow-400"></i>
                    <h1 class="text-2xl font-bold">Nissi Pizza - Administracion</h1>
                </div>
                <div class="flex items-center space-x-3">
                    <a href="/" class="bg-orange-600 hover:bg-orange-700 px-4 py-2 rounded-lg transition">
                        <i class="fas fa-arrow-left mr-2"></i>Volver
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="bg-slate-800 border-b border-slate-700">
        <div class="container mx-auto px-4">
            <nav class="flex space-x-1">
                <button onclick="mostrarSeccion('dashboard')" id="tab-dashboard"
                    class="tab-btn px-6 py-3 font-semibold border-b-2 border-transparent hover:border-blue-500 transition">
                    <i class="fas fa-chart-line mr-2"></i>Dashboard
                </button>
                <button onclick="mostrarSeccion('categorias')" id="tab-categorias"
                    class="tab-btn px-6 py-3 font-semibold border-b-2 border-transparent hover:border-blue-500 transition">
                    <i class="fas fa-folder mr-2"></i>Categorias
                </button>
                <button onclick="mostrarSeccion('productos')" id="tab-productos"
                    class="tab-btn px-6 py-3 font-semibold border-b-2 border-transparent hover:border-blue-500 transition">
                    <i class="fas fa-box mr-2"></i>Productos
                </button>
                <button onclick="mostrarSeccion('vinculaciones')" id="tab-vinculaciones"
                    class="tab-btn px-6 py-3 font-semibold border-b-2 border-transparent hover:border-blue-500 transition">
                    <i class="fas fa-link mr-2"></i>Vinculaciones
                </button>
                <button onclick="mostrarSeccion('dos-sabores')" id="tab-dos-sabores"
                    class="tab-btn px-6 py-3 font-semibold border-b-2 border-transparent hover:border-blue-500 transition">
                    <i class="fas fa-pizza-slice mr-2"></i>Dos Sabores
                </button>
                <button onclick="mostrarSeccion('inventario')" id="tab-inventario"
                    class="tab-btn px-6 py-3 font-semibold border-b-2 border-transparent hover:border-blue-500 transition">
                    <i class="fas fa-warehouse mr-2"></i>Inventario
                </button>
                <button onclick="mostrarSeccion('configuracion')" id="tab-configuracion"
                    class="tab-btn px-6 py-3 font-semibold border-b-2 border-transparent hover:border-blue-500 transition">
                    <i class="fas fa-cog mr-2"></i>Configuracion
                </button>
            </nav>
            <!-- SECCIÃ©â€œN: DASHBOARD -->
            <div id="seccion-dashboard" class="seccion hidden">
                <h2 class="text-3xl font-bold mb-6">Dashboard de Ventas</h2>

                <!-- Control de Caja -->
                <div class="bg-gradient-to-r from-blue-900 to-purple-900 rounded-lg p-6 mb-8">
                    <h3 class="text-2xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-cash-register mr-3 text-green-400"></i>
                        Control de Caja
                    </h3>
                    <div id="caja-estado" class="flex items-center justify-between">
                        <div>
                            <div id="caja-info" class="text-lg mb-2">Verificando estado...</div>
                            <div id="caja-monto-inicial" class="text-sm text-gray-300"></div>
                        </div>
                        <div class="flex gap-4">
                            <button id="btn-abrir-caja" onclick="mostrarModalAbrirCaja()"
                                class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-semibold hidden">
                                <i class="fas fa-lock-open mr-2"></i>Abrir Caja
                            </button>
                            <button id="btn-cerrar-caja" onclick="cerrarCaja()"
                                class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-semibold hidden">
                                <i class="fas fa-lock mr-2"></i>Cerrar Caja
                            </button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <div class="bg-slate-800 rounded-lg p-6">
                        <h3 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-chart-line mr-2 text-green-400"></i>
                            Ventas del Dia
                        </h3>
                        <div class="mb-4">
                            <label class="block text-sm mb-2">Fecha:</label>
                            <input type="date" id="dashboard-fecha"
                                class="bg-slate-700 px-4 py-2 rounded border border-slate-600 text-white" />
                            <button onclick="cargarVentasDia()"
                                class="ml-2 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded">Ver</button>
                        </div>
                        <div id="dashboard-ventas-dia" class="text-2xl font-bold text-green-300 mb-2">$0</div>
                        <div id="dashboard-pedidos-count" class="text-sm text-gray-400">0 pedidos</div>
                    </div>
                    <div class="bg-slate-800 rounded-lg p-6">
                        <h3 class="text-xl font-semibold mb-4 flex items-center">
                            <i class="fas fa-history mr-2 text-yellow-400"></i>
                            Historial de Cierres de Caja
                        </h3>
                        <div id="dashboard-historial-caja" class="space-y-2 text-sm max-h-64 overflow-y-auto">
                            Cargando historial...
                        </div>
                    </div>
                </div>

                <!-- Detalle de Pedidos del Dia -->
                <div class="bg-slate-800 rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-receipt mr-2 text-blue-400"></i>
                        Detalle de Pedidos
                    </h3>
                    <div id="dashboard-pedidos-detalle" class="space-y-4">
                        <p class="text-gray-400">Selecciona una fecha para ver los pedidos</p>
                    </div>
                </div>
            </div>

            <!-- Modal: Abrir Caja -->
            <div id="modal-abrir-caja"
                class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
                <div class="bg-slate-800 rounded-lg p-8 max-w-md w-full mx-4">
                    <h3 class="text-2xl font-bold mb-4">Abrir Caja</h3>
                    <div class="mb-4">
                        <label class="block text-sm mb-2">Usuario que abre la caja:</label>
                        <input type="text" id="usuario-apertura" placeholder="Nombre de usuario (sin contrasena)"
                            class="w-full bg-slate-700 px-4 py-2 rounded border border-slate-600 mb-3">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm mb-2">Monto inicial en caja:</label>
                        <input type="number" id="monto-inicial-caja" step="0.01" min="0" placeholder="0.00"
                            class="w-full bg-slate-700 px-4 py-2 rounded border border-slate-600">
                    </div>
                    <div class="flex gap-4">
                        <button onclick="abrirCaja()"
                            class="flex-1 bg-green-600 hover:bg-green-700 px-6 py-3 rounded font-semibold">
                            <i class="fas fa-check mr-2"></i>Abrir
                        </button>
                        <button onclick="cerrarModalAbrirCaja()"
                            class="flex-1 bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded font-semibold">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">

        <!-- SECCIÃ©â€œN: CATEGORÃ©ÂAS -->
        <div id="seccion-categorias" class="seccion hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold">Gestion de Categorias</h2>
                <button onclick="abrirModalCategoria()"
                    class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-semibold transition">
                    <i class="fas fa-plus mr-2"></i>Nueva Categoria
                </button>
            </div>

            <div class="bg-red-900 bg-opacity-30 border border-red-500 rounded-lg p-4 mb-6">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-red-400 text-2xl mr-3"></i>
                    <div>
                        <h3 class="font-bold text-red-300">Zona de Peligro</h3>
                        <p class="text-sm text-red-200">Si deseas empezar desde cero, puedes eliminar todo el menu
                            (categorias y productos).</p>
                    </div>
                    <button onclick="confirmarLimpiarMenu()"
                        class="ml-auto bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-semibold whitespace-nowrap">
                        Limpiar Todo
                    </button>
                </div>
            </div>

            <div id="lista-categorias" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Las categorias se cargaran aqui -->
            </div>
        </div>

        <!-- SECCIÃ©â€œN: PRODUCTOS -->
        <div id="seccion-productos" class="seccion hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold">Gestion de Productos</h2>
                <div class="flex space-x-3">
                    <select id="filtro-categoria" onchange="actualizarFiltrosSubcategoria()"
                        class="bg-slate-700 px-4 py-2 rounded-lg border border-slate-600">
                        <option value="">Todas las categorias</option>
                    </select>
                    <select id="filtro-subcategoria" onchange="filtrarProductos()"
                        class="bg-slate-700 px-4 py-2 rounded-lg border border-slate-600" style="display: none;">
                        <option value="">Todas las subcategorias</option>
                    </select>
                    <button onclick="abrirModalProducto()"
                        class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-semibold transition">
                        <i class="fas fa-plus mr-2"></i>Nuevo Producto
                    </button>
                </div>
            </div>

            <div id="lista-productos" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Los productos se cargaran aqui -->
            </div>
        </div>

        <!-- SECCIÃ©â€œN: VINCULACIONES -->
        <div id="seccion-vinculaciones" class="seccion hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold">Vinculaciones de Productos</h2>
                <button onclick="abrirModalVinculacion()"
                    class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-semibold transition">
                    <i class="fas fa-plus mr-2"></i>Nueva Vinculacion
                </button>
            </div>

            <div class="bg-blue-900 bg-opacity-30 border border-blue-500 rounded-lg p-4 mb-6">
                <div class="flex items-center">
                    <i class="fas fa-info-circle text-blue-400 text-2xl mr-3"></i>
                    <div>
                        <h3 class="font-bold text-blue-300">Sistema de Vinculaciones</h3>
                        <p class="text-sm text-blue-200">Permite combinar productos automaticamente. Por ejemplo: Pizza
                            Hawaiana + Coca Cola + Borde de Queso.</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-slate-800 rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-link mr-2 text-green-400"></i>
                        Vinculaciones Activas
                    </h3>
                    <div id="vinculaciones-activas" class="space-y-3">
                        <!-- Las vinculaciones se cargaran aqui -->
                    </div>
                </div>

                <div class="bg-slate-800 rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-plus-circle mr-2 text-blue-400"></i>
                        Crear Nueva Vinculacion
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm mb-2">Producto Principal</label>
                            <select id="vinculacion-producto-principal"
                                class="w-full px-4 py-2 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                                <option value="">Selecciona producto principal</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm mb-2">Tipo de Vinculacion</label>
                            <select id="vinculacion-tipo" onchange="filtrarProductosVinculados()"
                                class="w-full px-4 py-2 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                                <option value="bebida">Bebida</option>
                                <option value="adicional">Adicional</option>
                                <option value="complemento">Complemento</option>
                            </select>
                        </div>
                        <div id="filtro-subcategoria-div" style="display:none;">
                            <label class="block text-sm mb-2">Filtrar por Tipo de Bebida</label>
                            <select id="vinculacion-filtro-subcategoria" onchange="filtrarProductosVinculados()"
                                class="w-full px-4 py-2 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                                <option value="">Todos los tipos</option>
                                <option value="gaseosa">Gaseosas</option>
                                <option value="limonada">Limonadas</option>
                                <option value="jugo">Jugos Naturales</option>
                                <option value="agua">Aguas</option>
                                <option value="te">Tes</option>
                                <option value="energizante">Energizantes</option>
                                <option value="cerveza">Cervezas</option>
                                <option value="vino">Vinos</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm mb-2">Productos a Vincular (selecciona varios)</label>
                            <div id="vinculacion-productos-lista"
                                class="max-h-64 overflow-y-auto bg-slate-700 rounded-lg border border-slate-600 p-3 space-y-2">
                                <!-- Los checkboxes se cargaran aqui -->
                            </div>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="vinculacion-obligatorio" class="mr-2 w-4 h-4">
                            <label class="text-sm">Obligatorio</label>
                        </div>
                        <div>
                            <label class="block text-sm mb-2">Precio Adicional ($)</label>
                            <input type="number" id="vinculacion-precio" step="0.01" min="0" placeholder="0.00"
                                class="w-full px-4 py-2 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                            <p class="text-xs text-gray-400 mt-1">Se aplicara a todos los productos seleccionados</p>
                        </div>
                        <button onclick="crearVinculacionesMultiples()"
                            class="w-full bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-semibold transition">
                            <i class="fas fa-plus mr-2"></i>Crear Vinculaciones
                        </button>
                    </div>
                </div>
            </div>
        </div>


        <!-- SECCION: DOS SABORES -->
        <div id="seccion-dos-sabores" class="seccion hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold">Configuracion de Dos Sabores</h2>
            </div>

            <div class="bg-slate-800 rounded-lg p-6 mb-6">
                <div class="flex items-center mb-4">
                    <i class="fas fa-info-circle text-blue-400 mr-3 text-xl"></i>
                    <div>
                        <h3 class="font-bold text-blue-300">Sistema de Dos Sabores</h3>
                        <p class="text-gray-400 text-sm">Configura productos que pueden tener dos sabores (ej: pizza
                            mitad y mitad). Selecciona los sabores disponibles para cada producto.</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Lista de productos con dos sabores -->
                <div class="bg-slate-800 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4">
                        <i class="fas fa-list mr-2"></i>Productos con Dos Sabores
                    </h3>
                    <div class="mb-4">
                        <select id="filtro-categoria-dos-sabores" onchange="cargarProductosDosSabores()"
                            class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2">
                            <option value="">Todas las categorias</option>
                        </select>
                    </div>
                    <div id="lista-productos-dos-sabores" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Los productos se cargaran aqui -->
                        <p class="text-gray-400 text-center py-4">Cargando productos...</p>
                    </div>
                </div>

                <!-- Configuracion de sabores para producto seleccionado -->
                <div class="bg-slate-800 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4">
                        <i class="fas fa-cog mr-2"></i>Configurar Sabores
                    </h3>
                    <div id="config-sabores-producto" class="hidden">
                        <div class="mb-4 p-4 bg-slate-700 rounded-lg">
                            <h4 id="nombre-producto-sabores" class="font-bold text-lg mb-2">Producto</h4>
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="toggle-permite-dos-sabores"
                                    onchange="togglePermiteDosSabores()" class="w-5 h-5 rounded">
                                <span>Permitir dos sabores</span>
                            </label>
                            <label class="flex items-center gap-3 cursor-pointer mt-3">
                                <input type="checkbox" id="toggle-permite-tres-sabores"
                                    onchange="togglePermiteTresSabores()" class="w-5 h-5 rounded">
                                <span>Permitir tres sabores (tercios)</span>
                            </label>
                        </div>

                        <div id="seccion-agregar-sabores" class="hidden">
                            <h4 class="font-semibold mb-3">Sabores disponibles:</h4>
                            <div id="lista-sabores-configurados" class="space-y-2 mb-4 max-h-40 overflow-y-auto">
                                <!-- Sabores configurados -->
                            </div>

                            <div class="border-t border-slate-600 pt-4 mt-4">
                                <h4 class="font-semibold mb-3">Agregar sabor:</h4>
                                <select id="select-nuevo-sabor"
                                    class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 mb-3">
                                    <option value="">Selecciona un producto como sabor</option>
                                </select>
                                <button onclick="agregarSaborProducto()"
                                    class="w-full bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg font-semibold transition">
                                    <i class="fas fa-plus mr-2"></i>Agregar Sabor
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="placeholder-config-sabores" class="text-center py-8 text-gray-400">
                        <i class="fas fa-hand-pointer text-4xl mb-3"></i>
                        <p>Selecciona un producto de la lista para configurar sus sabores</p>
                    </div>
                </div>
            </div>
        </div>


        <!-- SECCIÃ©â€œN: INVENTARIO -->
        <div id="seccion-inventario" class="seccion hidden">
            <h2 class="text-3xl font-bold mb-6">Gestion de Inventario</h2>

            <div class="bg-slate-800 rounded-lg p-6">
                <div class="flex items-center mb-4">
                    <i class="fas fa-info-circle text-blue-400 mr-2"></i>
                    <p class="text-gray-300">El inventario se crea automaticamente al agregar productos. Aqui puedes
                        gestionar el stock.</p>
                </div>

                <div id="lista-inventario" class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-slate-700">
                                <th class="text-left py-3 px-4">Producto</th>
                                <th class="text-left py-3 px-4">Categoria</th>
                                <th class="text-center py-3 px-4">Stock Actual</th>
                                <th class="text-center py-3 px-4">Stock Minimo</th>
                                <th class="text-center py-3 px-4">Estado</th>
                                <th class="text-center py-3 px-4">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-inventario-body">
                            <!-- Rows will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>


        <!-- SECCIÃ©â€œN: CONFIGURACIÃ©â€œN -->
        <div id="seccion-configuracion" class="seccion hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold">Configuracion de Domicilios</h2>
            </div>

            <!-- Configuracion General -->
            <div class="bg-slate-800 rounded-lg p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <i class="fas fa-cog text-blue-400 text-2xl mr-3"></i>
                        <div>
                            <h3 class="text-xl font-semibold">Configuracion General</h3>
                            <p class="text-gray-400 text-sm">Sistema de precios de domicilio</p>
                        </div>
                    </div>
                    <div id="estado-sistema" class="text-lg font-semibold text-orange-400">
                        Cargando...
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-slate-700 rounded-lg p-4">
                        <h4 class="font-semibold mb-3 flex items-center">
                            <i class="fas fa-dollar-sign mr-2 text-green-400"></i>
                            Precio por Defecto
                        </h4>
                        <p class="text-sm text-gray-300 mb-3">
                            Precio cuando no hay zona configurada o el sistema de zonas esta desactivado
                        </p>
                        <input type="number" id="precio-default" step="100" min="0" placeholder="3000"
                            class="w-full px-4 py-2 bg-slate-600 rounded-lg border border-slate-500 focus:border-blue-500 focus:outline-none">
                    </div>

                    <div class="bg-slate-700 rounded-lg p-4">
                        <h4 class="font-semibold mb-3 flex items-center">
                            <i class="fas fa-map-marked-alt mr-2 text-purple-400"></i>
                            Sistema de Precios por Zona
                        </h4>
                        <p class="text-sm text-gray-300 mb-3">
                            Activar precios dinamicos segun municipio y barrio
                        </p>
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="usar-precios-zona"
                                class="w-6 h-6 rounded bg-slate-600 border-slate-500 text-blue-600 focus:ring-blue-500">
                            <span class="ml-3 text-sm font-medium">Usar precios por zona</span>
                        </label>
                    </div>
                </div>

                <div class="mt-4">
                    <button onclick="guardarConfiguracion()"
                        class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-semibold transition">
                        <i class="fas fa-save mr-2"></i>Guardar Configuracion
                    </button>
                </div>
            </div>

            <!-- Gestion de Zonas -->
            <div class="bg-slate-800 rounded-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <i class="fas fa-map-marked-alt text-purple-400 text-2xl mr-3"></i>
                        <div>
                            <h3 class="text-xl font-semibold">Zonas de Precio</h3>
                            <p class="text-gray-400 text-sm">Configura precios segun municipio y barrio</p>
                        </div>
                    </div>
                    <button onclick="mostrarModalNuevaZona()"
                        class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-semibold transition">
                        <i class="fas fa-plus mr-2"></i>Agregar Zona
                    </button>
                </div>

                <!-- Tabla de Zonas -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-700">
                        <thead class="bg-slate-700">
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                    Municipio
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                    Barrio
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                    Precio
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                    Observaciones
                                </th>
                                <th
                                    class="px-6 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider">
                                    Acciones
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tabla-zonas-body" class="bg-slate-800 divide-y divide-slate-700">
                            <tr>
                                <td colspan="5" class="px-6 py-8 text-center text-gray-400">
                                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                    <p>Cargando zonas...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Ayuda -->
                <div class="mt-6 bg-blue-900 bg-opacity-20 border border-blue-500 rounded-lg p-4">
                    <div class="flex">
                        <i class="fas fa-info-circle text-blue-400 mr-3 mt-1"></i>
                        <div class="text-sm text-gray-300">
                            <p class="font-semibold mb-2">Como funciona el sistema de precios por zona:</p>
                            <ul class="list-disc ml-5 space-y-1">
                                <li><strong>Barrio especifico:</strong> Si defines un precio para un barrio concreto
                                    (ej: "Laureles, Medellin"), ese precio tendra prioridad</li>
                                <li><strong>Municipio general:</strong> Si solo defines el municipio sin barrio (ej:
                                    "Medellin"), ese precio se aplica a todos los barrios no especificados</li>
                                <li><strong>Precio por defecto:</strong> Si no hay configuracion para el municipio, se
                                    usa el precio por defecto</li>
                                <li><strong>Geocodificacion automatica:</strong> El sistema detecta automaticamente el
                                    municipio y barrio cuando el cliente ingresa su direccion</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL: Crear/Editar Zona de Precio -->
        <div id="modal-zona" class="modal hidden">
            <div class="bg-slate-800 rounded-lg p-6 max-w-lg w-full">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold" id="modal-zona-titulo">Nueva Zona de Precio</h3>
                    <button type="button" onclick="cerrarModalZona()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form id="form-zona" class="space-y-4">
                    <div>
                        <label class="block font-medium mb-2 text-sm">Municipio *</label>
                        <input type="text" id="zona-municipio" required
                            class="w-full px-4 py-2 bg-slate-700 rounded border border-slate-600 focus:border-blue-500 focus:outline-none"
                            placeholder="Ej: Medellin, Envigado, Itagui">
                        <p class="text-xs text-gray-400 mt-1">Nombre del municipio o ciudad</p>
                    </div>

                    <div>
                        <label class="block font-medium mb-2 text-sm">Barrio (opcional)</label>
                        <input type="text" id="zona-barrio"
                            class="w-full px-4 py-2 bg-slate-700 rounded border border-slate-600 focus:border-blue-500 focus:outline-none"
                            placeholder="Ej: Laureles, Poblado">
                        <p class="text-xs text-gray-400 mt-1">Dejalo vacio para aplicar a todo el municipio</p>
                    </div>

                    <div>
                        <label class="block font-medium mb-2 text-sm">Precio *</label>
                        <input type="number" id="zona-precio" required step="100" min="0"
                            class="w-full px-4 py-2 bg-slate-700 rounded border border-slate-600 focus:border-blue-500 focus:outline-none"
                            placeholder="5000">
                        <p class="text-xs text-gray-400 mt-1">Precio del domicilio en pesos colombianos</p>
                    </div>

                    <div>
                        <label class="block font-medium mb-2 text-sm">Observaciones</label>
                        <textarea id="zona-observaciones" rows="2"
                            class="w-full px-4 py-2 bg-slate-700 rounded border border-slate-600 focus:border-blue-500 focus:outline-none"
                            placeholder="Notas adicionales sobre esta zona"></textarea>
                    </div>

                    <div class="hidden" id="zona-activo-container">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="zona-activo" checked
                                class="w-5 h-5 rounded bg-slate-600 border-slate-500 text-blue-600">
                            <span class="ml-2 text-sm">Zona activa</span>
                        </label>
                    </div>

                    <div class="flex gap-3 pt-4">
                        <button type="button" onclick="guardarZona()"
                            class="flex-1 bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg font-semibold transition">
                            <i class="fas fa-save mr-2"></i>Guardar
                        </button>
                        <button type="button" onclick="cerrarModalZona()"
                            class="flex-1 bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg font-semibold transition">
                            <i class="fas fa-times mr-2"></i>Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>

    </main>

    <!-- MODAL: Crear/Editar Categoria -->
    <div id="modal-categoria" class="modal">
        <div class="bg-slate-800 rounded-lg p-4 max-w-md w-full">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-xl font-bold" id="titulo-modal-categoria">Nueva Categoria</h3>
                <button type="button" onclick="cerrarModal('modal-categoria')" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="form-categoria" onsubmit="guardarCategoria(event)" class="space-y-2">
                <input type="hidden" id="categoria-id">

                <div class="mb-4">
                    <label class="block font-medium mb-1 text-sm">Ícono</label>
                    <div class="flex items-center gap-2">
                        <select id="categoria-icono"
                            class="w-full px-3 py-1 text-sm bg-slate-700 rounded border border-slate-600 focus:border-blue-500 focus:outline-none">
                            <!-- Opciones comunes de Font Awesome (valor = clase) -->
                            <option value="fas fa-tag">Tag</option>
                            <option value="fas fa-pizza-slice">Pizza</option>
                            <option value="fas fa-utensils">Utensilios</option>
                            <option value="fas fa-box">Caja</option>
                            <option value="fas fa-folder">Carpeta</option>
                            <option value="fas fa-link">Vinculo</option>
                            <option value="fas fa-warehouse">Inventario</option>
                            <option value="fas fa-cash-register">Caja</option>
                            <option value="fas fa-chart-line">Ventas</option>
                            <option value="fas fa-history">Historial</option>
                            <option value="fas fa-receipt">Recibo</option>
                            <option value="fas fa-plus">Agregar</option>
                            <option value="fas fa-edit">Editar</option>
                            <option value="fas fa-trash">Eliminar</option>
                            <option value="fas fa-truck">Reparto</option>
                            <option value="fas fa-shopping-cart">Carrito</option>
                            <option value="fas fa-beer">Bebidas</option>
                            <option value="fas fa-wine-glass">Vinos</option>
                            <option value="fas fa-mug-hot">Bebidas Calientes</option>
                            <option value="fas fa-star">Favoritos</option>
                        </select>
                        <div id="categoria-icono-preview"
                            class="w-10 h-10 rounded-full flex items-center justify-center text-white"
                            style="background:#ff7a18">
                            <i class="fas fa-tag"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Selecciona un icono para la categoria. Ej:
                        <code>fas fa-pizza-slice</code>
                    </p>
                </div>

                <div class="mb-2">
                    <label class="block font-medium mb-1 text-sm">Nombre de la Categoria *</label>
                    <input type="text" id="categoria-nombre" required
                        class="w-full px-3 py-1 text-sm bg-slate-700 rounded border border-slate-600 focus:border-blue-500 focus:outline-none"
                        placeholder="Ej: Pizzas Premium">
                </div>

                <div class="mb-2">
                    <label class="block font-medium mb-1 text-sm">Descripcion</label>
                    <textarea id="categoria-descripcion" rows="1"
                        class="w-full px-3 py-1 text-sm bg-slate-700 rounded border border-slate-600 focus:border-blue-500 focus:outline-none"></textarea>
                </div>

                <div class="mb-2">
                    <label class="block font-medium mb-1 text-sm">Categoria Padre</label>
                    <select id="categoria-padre"
                        class="w-full px-3 py-1 text-sm bg-slate-700 rounded border border-slate-600 focus:border-blue-500 focus:outline-none">
                        <option value="">Ninguna (categoria principal)</option>
                    </select>
                    <p class="text-xs text-gray-400 mt-1">Si es una subcategoria, seleccione la categoria padre</p>
                </div>

                <div class="mb-2">
                    <label class="block font-medium mb-1 text-sm">Categorias Compatibles</label>
                    <div id="categorias-compatibles-container"
                        class="bg-slate-700 p-2 rounded border border-slate-600 max-h-32 overflow-y-auto text-sm">
                        <!-- Se llenara dinamicamente con JavaScript -->
                    </div>
                    <p class="text-xs text-gray-400 mt-1">Seleccione las categorias que pueden combinarse con esta</p>
                </div>

                <div class="mb-2">
                    <label class="flex items-center text-sm">
                        <input type="checkbox" id="es-adicion" class="mr-2 w-4 h-4">
                        <span>Es una adicion (puede agregarse a otros productos)</span>
                    </label>
                    <p class="text-xs text-gray-400 mt-1">Marque si esta categoria contiene productos que pueden ser
                        adiciones</p>
                </div>

                <div class="mb-3">
                    <label class="block font-medium mb-1 text-sm">Campos que requieren los productos:</label>
                    <div class="space-y-1">
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="campo-ingredientes" class="mr-2 w-4 h-4">
                            <span>Ingredientes (Para pizzas, pastas, etc.)</span>
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="campo-tamanos" class="mr-2 w-4 h-4">
                            <span>Tamanios con precios (Personal, Mediano, Grande)</span>
                        </label>
                        <label class="flex items-center text-sm">
                            <input type="checkbox" id="campo-mililitros" class="mr-2 w-4 h-4">
                            <span>Mililitros (Para bebidas: 250ml, 500ml, 1L)</span>
                        </label>
                    </div>
                </div>

                <div class="mb-2">
                    <label class="flex items-center text-sm">
                        <input type="checkbox" id="categoria-visible-publico" class="mr-2 w-4 h-4">
                        <span>Visible en menu publico</span>
                    </label>
                    <p class="text-xs text-gray-400 mt-1">Si esta desmarcado, la categoria no aparecera en el menu
                        publico aunque los productos sigan accesibles por vinculaciones.</p>
                </div>

                <div class="mb-2">
                    <label class="flex items-center text-sm">
                        <input type="checkbox" id="categoria-default-domicilio" class="mr-2 w-4 h-4">
                        <span>Predeterminada en Domicilios</span>
                    </label>
                    <p class="text-xs text-gray-400 mt-1">Si marca esta opcion, la categoria seleccionada sera la
                        categoria inicial que veran los clientes en el menu publico (solo una categoria puede ser
                        predeterminada).</p>
                </div>

                <div class="flex justify-end space-x-3 pt-1">
                    <button type="button" onclick="cerrarModal('modal-categoria')"
                        class="px-4 py-1 text-sm bg-gray-600 hover:bg-gray-700 rounded transition">
                        Cancelar
                    </button>
                    <button type="submit" class="px-4 py-1 text-sm bg-blue-600 hover:bg-blue-700 rounded transition">
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: Crear/Editar Producto -->
    <div id="modal-producto"
        class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50 overflow-y-auto">
        <div class="bg-slate-800 rounded-lg p-8 max-w-2xl w-full mx-4 my-8">
            <h3 class="text-2xl font-bold mb-6" id="titulo-modal-producto">Nuevo Producto</h3>
            <form id="form-producto" onsubmit="guardarProducto(event)">
                <input type="hidden" id="producto-id">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block font-medium mb-2">Nombre del Producto *</label>
                        <input type="text" id="producto-nombre" required
                            class="w-full px-4 py-2 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                    </div>

                    <div class="md:col-span-2">
                        <label class="block font-medium mb-2">Descripcion</label>
                        <textarea id="producto-descripcion" rows="2"
                            class="w-full px-4 py-2 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none"></textarea>
                    </div>

                    <div class="md:col-span-2">
                        <label class="block font-medium mb-2">Imagen del Producto</label>
                        <input type="file" id="producto-imagen" accept="image/*"
                            class="w-full px-4 py-2 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                        <p class="text-sm text-gray-400 mt-1">Selecciona una imagen para el producto (opcional)</p>
                    </div>

                    <div>
                        <label class="block font-medium mb-2">Categoria *</label>
                        <select id="producto-categoria" required onchange="actualizarCamposProducto()"
                            class="w-full px-4 py-2 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                            <option value="">Selecciona una categoria</option>
                        </select>
                    </div>

                    <div id="div-subcategoria" style="display: none;">
                        <label class="block font-medium mb-2">Subcategoria</label>
                        <select id="producto-subcategoria" onchange="actualizarCamposProducto()"
                            class="w-full px-4 py-2 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                            <option value="">Selecciona una subcategoria (opcional)</option>
                        </select>
                        <p class="text-sm text-gray-400 mt-1">Para bebidas: gaseosa, limonada, etc.</p>
                    </div>

                    <div>
                        <label class="block font-medium mb-2">Stock Minimo</label>
                        <input type="number" id="producto-stock-minimo" value="10" min="0" step="1"
                            class="w-full px-4 py-2 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                    </div>
                </div>

                <!-- Campos dinamicos segun categoria -->
                <div id="campos-dinamicos-producto" class="mt-6">
                    <!-- Se llenaran dinamicamente segun la categoria -->
                </div>

                <!-- Seccion de Precios -->
                <div id="seccion-precios" class="mt-6">
                    <div class="flex justify-between items-center mb-3">
                        <label class="block font-medium">Precios *</label>
                        <button type="button" onclick="agregarPrecio()"
                            class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-sm">
                            <i class="fas fa-plus mr-1"></i>Agregar Precio
                        </button>
                    </div>
                    <div id="lista-precios" class="space-y-2">
                        <!-- Los precios se agregaran aqui -->
                    </div>
                </div>

                <div class="flex justify-end space-x-4 mt-8">
                    <button type="button" onclick="cerrarModal('modal-producto')"
                        class="px-6 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg transition">
                        Cancelar
                    </button>
                    <button type="submit" class="px-6 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition">
                        Guardar Producto
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: Actualizar Stock -->
    <div id="modal-stock" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50">
        <div class="bg-slate-800 rounded-lg p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold mb-6">Actualizar Stock</h3>
            <form id="form-stock" onsubmit="actualizarStock(event)">
                <input type="hidden" id="stock-producto-id">

                <div class="mb-4">
                    <label class="block font-medium mb-2">Producto</label>
                    <p id="stock-producto-nombre" class="px-4 py-2 bg-slate-700 rounded-lg text-gray-300"></p>
                </div>

                <div class="mb-4">
                    <label class="block font-medium mb-2">Stock Actual</label>
                    <input type="number" id="stock-actual" required min="0" step="0.01"
                        class="w-full px-4 py-2 bg-slate-700 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none">
                </div>

                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="cerrarModal('modal-stock')"
                        class="px-6 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg transition">
                        Cancelar
                    </button>
                    <button type="submit" class="px-6 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition">
                        Actualizar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: Configurar Opciones/Adiciones -->
    <div id="modalAsignarGrupos" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50">
        <div class="bg-slate-800 rounded-lg p-8 max-w-2xl w-full mx-4 text-white">
            <h3 class="text-2xl font-bold mb-6" id="tituloModalAsignar">Configurar Opciones</h3>
            <input type="hidden" id="productoIdAsignar">
            <div id="listaGruposAsignar"
                class="text-gray-300 space-y-2 max-h-72 overflow-y-auto p-2 border border-slate-700 rounded-md"></div>
            <div class="flex justify-end space-x-4 mt-8">
                <button type="button" onclick="cerrarModalAsignar()"
                    class="px-6 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg text-white transition">
                    Cancelar
                </button>
                <button id="btnGuardarAsignacion" type="button" onclick="guardarAsignacion()"
                    class="px-6 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-white transition">
                    Guardar Configuracion
                </button>
            </div>
        </div>
    </div>


    <!-- Notifications Container -->
    <div id="notifications-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script src="./js/notifications.js"></script>
    <!-- Script legacy conflictivo desactivado -->
    <!-- <script src="./js/admin.js"></script> -->
    <script src="./js/precios-zona.js"></script>
    <script>
        // ==================== VARIABLES GLOBALES ====================
        let categoriasData = [];
        let productosData = [];
        let categoriaActual = null;
        let productoActual = null;
        let preciosContador = 0;

        // ==================== DASHBOARD ====================
        // Obtener fecha en zona horaria de Colombia
        function getFechaColombia() {
            const ahora = new Date();
            // Colombia es UTC-5
            const offsetColombia = -5 * 60;
            const offsetLocal = ahora.getTimezoneOffset();
            const diferenciaMinutos = offsetColombia - offsetLocal;
            const fechaColombia = new Date(ahora.getTime() + diferenciaMinutos * 60000);
            return fechaColombia.toISOString().slice(0, 10);
        }

        async function cargarVentasDia() {
            const inputFecha = document.getElementById('dashboard-fecha');
            const fecha = inputFecha.value || getFechaColombia();
            inputFecha.value = fecha;

            try {
                // Cargar total de ventas
                const resp = await fetch(`${API_BASE_URL}/api/caja/ventas-dia?fecha=${fecha}`);
                const data = await resp.json();
                document.getElementById('dashboard-ventas-dia').textContent = `$${data.total_ventas?.toFixed(2) || 0}`;

                // Cargar detalles de pedidos
                const respPedidos = await fetch(`${API_BASE_URL}/api/caja/pedidos-dia?fecha=${fecha}`);
                const dataPedidos = await respPedidos.json();

                document.getElementById('dashboard-pedidos-count').textContent = `${dataPedidos.total_pedidos || 0} pedidos`;

                // Mostrar detalle de pedidos
                cargarDetallePedidos(dataPedidos.pedidos || []);
            } catch (e) {
                document.getElementById('dashboard-ventas-dia').textContent = 'Error';
                document.getElementById('dashboard-pedidos-detalle').innerHTML =
                    `<p class="text-red-400">Error cargando datos: ${e.message}</p>`;
                console.error('Error cargando ventas:', e);
            }
        }

        function cargarDetallePedidos(pedidos) {
            const cont = document.getElementById('dashboard-pedidos-detalle');

            if (!pedidos || pedidos.length === 0) {
                cont.innerHTML = '<p class="text-gray-400">No hay pedidos para esta fecha</p>';
                return;
            }

            cont.innerHTML = pedidos.map(pedido => {
                const estadoColor = {
                    'pendiente': 'bg-yellow-600',
                    'en_preparacion': 'bg-blue-600',
                    'listo': 'bg-green-600',
                    'entregado': 'bg-gray-600',
                    'cancelado': 'bg-red-600'
                }[pedido.estado] || 'bg-gray-600';

                const itemsHtml = pedido.items.map(item => {
                    let detalles = [];
                    if (item.tamano) detalles.push(`<span class="text-blue-300">${item.tamano}</span>`);
                    // Resolver segundo(s) sabor(es) de forma robusta: puede venir en 'segundo_sabor' (string)
                    // o en 'segundos_sabores' (lista de objetos {nombre}). Evitar mostrar 'undefined'.
                    let segundoDisplay = '';
                    try {
                        if (item.segundos_sabores && Array.isArray(item.segundos_sabores) && item.segundos_sabores.length > 0) {
                            const names = item.segundos_sabores.map(s => (s && (s.nombre || s.name)) || s).filter(x => x && String(x).trim() !== '');
                            if (names.length) segundoDisplay = names.join(', ');
                        }
                        if (!segundoDisplay && (item.segundo_sabor || item.segundo)) {
                            // puede venir como string o como objeto
                            const ss = item.segundo_sabor || item.segundo;
                            if (typeof ss === 'string') segundoDisplay = ss;
                            else if (Array.isArray(ss)) {
                                const names = ss.map(s => (s && (s.nombre || s.name)) || s).filter(x => x && String(x).trim() !== '');
                                if (names.length) segundoDisplay = names.join(', ');
                            } else if (typeof ss === 'object' && ss !== null) {
                                segundoDisplay = ss.nombre || ss.name || '';
                            }
                        }
                    } catch (e) {
                        console.warn('Error resolving segundos sabores display', e);
                    }
                    if (segundoDisplay) detalles.push(`<span class="text-orange-300">mitad ${segundoDisplay}</span>`);
                    const detallesStr = detalles.length > 0 ? `<div class="text-xs ml-4 text-gray-400">${detalles.join(' | ')}</div>` : '';
                    return `
                    <div class="py-2 border-b border-slate-600">
                        <div class="flex justify-between text-sm">
                            <span class="font-medium">${item.cantidad}x ${item.producto}</span>
                            <span class="text-green-300 font-semibold">${parseFloat(item.subtotal || 0).toLocaleString('es-CO')}</span>
                        </div>
                        ${detallesStr}
                    </div>`;
                }).join('');

                // Formatear fecha y hora para Colombia
                const formatearFecha = (fechaStr) => {
                    // La fecha viene de SQLite sin zona horaria, tratarla como local (Colombia)
                    // Agregar 'T' si no tiene y no agregar 'Z' para que no se interprete como UTC
                    let fechaLocal = fechaStr.replace(' ', 'T');
                    if (!fechaLocal.includes('T')) {
                        fechaLocal += 'T00:00:00';
                    }
                    // Parsear sin el sufijo Z para que se trate como hora local
                    const fecha = new Date(fechaLocal);

                    // Formatear manualmente
                    const dia = fecha.getDate().toString().padStart(2, '0');
                    const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
                    const anio = fecha.getFullYear();
                    let horas = fecha.getHours();
                    const minutos = fecha.getMinutes().toString().padStart(2, '0');
                    const ampm = horas >= 12 ? 'p. m.' : 'a. m.';
                    horas = horas % 12 || 12;

                    return `${dia}/${mes}/${anio}, ${horas}:${minutos} ${ampm}`;
                };

                return `
                    <div class="bg-slate-700 rounded-lg p-4 hover:bg-slate-600 transition">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-semibold text-lg">Pedido #${pedido.numero_pedido || pedido.id}</h4>
                                <p class="text-sm text-gray-400"><i class="fas fa-clock mr-1"></i>${formatearFecha(pedido.fecha_pedido)}</p>
                                ${pedido.nombre_cliente ? `<p class="text-sm"><i class="fas fa-user mr-1"></i>${pedido.nombre_cliente}</p>` : ''}
                                ${pedido.telefono_cliente ? `<p class="text-sm"><i class="fas fa-phone mr-1"></i>${pedido.telefono_cliente}</p>` : ''}
                                ${pedido.tipo_pedido === 'domicilio' && pedido.direccion_entrega ? `<p class="text-sm text-yellow-300"><i class="fas fa-map-marker-alt mr-1"></i>${pedido.direccion_entrega}</p>` : ''}
                                ${pedido.tipo_pedido === 'domicilio' && pedido.direccion_entrega ? `<p class="text-sm text-yellow-300"><i class="fas fa-map-marker-alt mr-1"></i>${pedido.direccion_entrega}</p>` : ''}
                                ${pedido.tipo_pedido === 'domicilio' && pedido.direccion_entrega ? `<p class="text-sm text-yellow-300"><i class="fas fa-map-marker-alt mr-1"></i>${pedido.direccion_entrega}</p>` : ''}
                            </div>
                            <div class="text-right">
                                <span class="${estadoColor} text-xs px-3 py-1 rounded-full">${pedido.estado}</span>
                                <p class="text-2xl font-bold text-green-300 mt-2">$${parseFloat(pedido.total).toFixed(2)}</p>
                                <p class="text-xs text-gray-400">${pedido.tipo_pedido || 'Local'}</p>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-slate-600">
                            <p class="text-xs text-gray-400 mb-2"><i class="fas fa-list mr-1"></i>Items:</p>
                            ${itemsHtml}
                        </div>
                            ${itemsHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==================== FUNCIONES DE UTILIDAD (Reemplazo de admin.js) ====================

        function mostrarSeccion(seccion) {
            // Ocultar todas las secciones
            document.querySelectorAll('.seccion').forEach(s => s.classList.add('hidden'));

            // Desactivar todos los tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-400', 'active');
                btn.classList.add('border-transparent');
            });

            // Mostrar seccion seleccionada
            const seccionEl = document.getElementById(`seccion-${seccion}`);
            if (seccionEl) seccionEl.classList.remove('hidden');

            // Activar tab
            const tabBtn = document.getElementById(`tab-${seccion}`);
            if (tabBtn) {
                tabBtn.classList.remove('border-transparent');
                tabBtn.classList.add('border-blue-500', 'text-blue-400', 'active');
            }

            // Cargar datos especificos
            // Cargar datos especificos
            if (seccion === 'dashboard') {
                if (typeof cargarVentasDia === 'function') cargarVentasDia();
            } else if (seccion === 'categorias') {
                if (typeof cargarCategorias === 'function') cargarCategorias();
            } else if (seccion === 'productos') {
                if (typeof cargarProductos === 'function') cargarProductos();
                if (typeof cargarCategoriasEnSelect === 'function') cargarCategoriasEnSelect();
            } else if (seccion === 'vinculaciones') {
                if (typeof cargarVinculaciones === 'function') cargarVinculaciones();
            } else if (seccion === 'dos-sabores') {
                if (typeof cargarProductosDosSabores === 'function') cargarProductosDosSabores();
                if (typeof cargarCategoriasEnSelectDosSabores === 'function') cargarCategoriasEnSelectDosSabores();
            } else if (seccion === 'inventario') {
                if (typeof cargarInventario === 'function') cargarInventario();
            } else if (seccion === 'configuracion') {
                if (typeof cargarConfiguracion === 'function') cargarConfiguracion();
                if (typeof cargarZonasPrecios === 'function') cargarZonasPrecios();
            }
        }

        function closeAllModals() {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active', 'show'));
        }

        // ==================== INICIALIZACIÓN ====================
        document.addEventListener('DOMContentLoaded', function () {
            // Inicializar Navegacion
            mostrarSeccion('dashboard');

            // Inicializar Estado Caja (Nueva logica)
            if (typeof inicializarEstadoCaja === 'function') inicializarEstadoCaja();

            // Inicializar Ventas
            cargarVentasDia();
        });


        // ==================== CATEGORÃ©ÂAS ====================
        async function cargarCategorias() {
            try {
                const response = await fetch(API_BASE_URL + '/api/categorias-config');
                categoriasData = await response.json();
                mostrarCategorias();
            } catch (error) {
                console.error('Error cargando categorias:', error);
                mostrarNotificacion('Error al cargar categorias', 'error');
            }
        }

        function mostrarCategorias() {
            const lista = document.getElementById('lista-categorias');
            if (categoriasData.length === 0) {
                lista.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-folder-open text-6xl text-gray-600 mb-4"></i>
                        <p class="text-xl text-gray-400">No hay categorias creadas</p>
                        <p class="text-gray-500 mt-2">Crea tu primera categoria para comenzar</p>
                    </div>
                `;
                return;
            }

            lista.innerHTML = categoriasData.map(cat => `
                <div class="bg-slate-800 rounded-lg p-6 card-hover">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <i class="${cat.icono} text-3xl text-blue-400"></i>
                            <div>
                                <h3 class="text-xl font-bold">${cat.nombre}</h3>
                                <p class="text-sm text-gray-400">${cat.descripcion || 'Sin descripcion'}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                            ${cat.activo ? '<span class="bg-green-600 text-xs px-2 py-1 rounded">Activa</span>' : '<span class="bg-gray-600 text-xs px-2 py-1 rounded">Inactiva</span>'}
                            ${cat.default_en_domicilio && cat.default_en_domicilio != 0 ? '<span class="bg-yellow-400 text-xs px-2 py-1 rounded ml-2 text-black">Predeterminada</span>' : ''}
                            <button onclick="toggleVisiblePublico(${cat.id}, ${cat.visible_en_publico || 1})" title="Alternar visibilidad publica" class="px-2 py-1 rounded text-sm border border-slate-600 hover:bg-slate-700">
                                ${cat.visible_en_publico && cat.visible_en_publico != 0 ? 'Visible' : 'Oculta'}
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-4 text-sm text-gray-400">
                        <p><strong>Campos requeridos:</strong></p>
                        <div class="flex flex-wrap gap-2 mt-2">
                            ${cat.campos_requeridos.ingredientes ? '<span class="bg-slate-700 px-2 py-1 rounded text-xs">🍕 Ingredientes</span>' : ''}
                            ${cat.campos_requeridos.tamanos ? '<span class="bg-slate-700 px-2 py-1 rounded text-xs">Tamaños</span>' : ''}
                            ${cat.campos_requeridos.mililitros ? '<span class="bg-slate-700 px-2 py-1 rounded text-xs"> Mililitros</span>' : ''}
                            ${!cat.campos_requeridos.ingredientes && !cat.campos_requeridos.tamanos && !cat.campos_requeridos.mililitros ? '<span class="text-xs">Ninguno</span>' : ''}
                        </div>
                    </div>

                    <div class="flex space-x-2">
                        <button onclick="editarCategoria(${cat.id})" class="flex-1 bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded transition">
                            <i class="fas fa-edit mr-2"></i>Editar
                        </button>
                        <button onclick="eliminarCategoria(${cat.id})" class="flex-1 bg-red-600 hover:bg-red-700 px-4 py-2 rounded transition">
                            <i class="fas fa-trash mr-2"></i>Eliminar
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function abrirModalCategoria() {
            categoriaActual = null;
            document.getElementById('titulo-modal-categoria').textContent = 'Nueva Categoria';
            document.getElementById('form-categoria').reset();
            document.getElementById('categoria-id').value = '';
            document.getElementById('categoria-icono').value = 'fas fa-tag';

            // Cargar categorias para el selector de categoria padre y compatibilidades
            cargarCategoriasEnFormulario();

            abrirModal('modal-categoria');
        }

        function cargarCategoriasEnFormulario() {
            // Llenar selector de categoria padre
            const selectCategoriaPadre = document.getElementById('categoria-padre');
            selectCategoriaPadre.innerHTML = '<option value="">Ninguna (categoria principal)</option>';

            // Llenar contenedor de categorias compatibles
            const contenedorCompatibles = document.getElementById('categorias-compatibles-container');
            contenedorCompatibles.innerHTML = '';

            // Obtener ID de la categoria actual (si estamos editando)
            const categoriaId = document.getElementById('categoria-id').value;

            // Agregar opciones de categorias existentes
            categoriasData.forEach(cat => {
                // No mostrar la categoria actual como opcion para padre o compatible
                if (categoriaId && cat.id == categoriaId) return;

                // Agregar como opcion para categoria padre
                selectCategoriaPadre.innerHTML += `<option value="${cat.id}">${cat.nombre}</option>`;

                // Agregar como opcion para categorias compatibles
                contenedorCompatibles.innerHTML += `
                    <label class="flex items-center p-2 hover:bg-slate-600 rounded">
                        <input type="checkbox" value="${cat.id}" class="mr-2 w-4 h-4">
                        <span>${cat.nombre}</span>
                    </label>
                `;
            });
        }

        function editarCategoria(id) {
            const categoria = categoriasData.find(c => c.id === id);
            if (!categoria) return;

            categoriaActual = categoria;
            document.getElementById('titulo-modal-categoria').textContent = 'Editar Categoria';
            document.getElementById('categoria-id').value = categoria.id;
            document.getElementById('categoria-nombre').value = categoria.nombre;
            document.getElementById('categoria-descripcion').value = categoria.descripcion || '';
            document.getElementById('categoria-icono').value = categoria.icono || 'fas fa-tag';

            // Actualizar la vista previa del icono
            try { updateIconPreview(); } catch (e) { /* noop */ }
            // Cargar las categorias en el formulario
            cargarCategoriasEnFormulario();

            // Establecer categoria padre si existe
            if (categoria.categoria_padre_id) {
                document.getElementById('categoria-padre').value = categoria.categoria_padre_id;
            } else {
                document.getElementById('categoria-padre').value = '';
            }

            // Establecer si es adicion
            document.getElementById('es-adicion').checked = categoria.es_adicion || false;

            // Marcar categorias compatibles
            const checkboxes = document.querySelectorAll('#categorias-compatibles-container input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = categoria.categorias_compatibles &&
                    categoria.categorias_compatibles.includes(parseInt(checkbox.value));
            });

            document.getElementById('campo-ingredientes').checked = categoria.campos_requeridos.ingredientes || false;
            document.getElementById('campo-tamanos').checked = categoria.campos_requeridos.tamanos || false;
            document.getElementById('campo-mililitros').checked = categoria.campos_requeridos.mililitros || false;

            // Establecer visibilidad publica si el campo existe
            try {
                document.getElementById('categoria-visible-publico').checked = (categoria.visible_en_publico === 1 || categoria.visible_en_publico === true);
            } catch (e) {
                // ignorar si no existe el checkbox
            }

            // Establecer default en domicilios si existe el campo
            try {
                document.getElementById('categoria-default-domicilio').checked = (categoria.default_en_domicilio === 1 || categoria.default_en_domicilio === true);
            } catch (e) {
                // ignorar si no existe
            }

            abrirModal('modal-categoria');
        }

        async function guardarCategoria(event) {
            event.preventDefault();

            const id = document.getElementById('categoria-id').value;

            // Obtener categorias compatibles seleccionadas
            const categoriasCompatiblesChecks = document.querySelectorAll('#categorias-compatibles-container input[type="checkbox"]:checked');
            const categoriasCompatibles = Array.from(categoriasCompatiblesChecks).map(check => parseInt(check.value));

            const data = {
                nombre: document.getElementById('categoria-nombre').value,
                descripcion: document.getElementById('categoria-descripcion').value,
                icono: document.getElementById('categoria-icono').value,
                categoria_padre_id: document.getElementById('categoria-padre').value || null,
                es_adicion: document.getElementById('es-adicion').checked,
                categorias_compatibles: categoriasCompatibles,
                campos_requeridos: {
                    ingredientes: document.getElementById('campo-ingredientes').checked,
                    tamanos: document.getElementById('campo-tamanos').checked,
                    mililitros: document.getElementById('campo-mililitros').checked
                }
            };
            // Incluir visibilidad publica
            try {
                data.visible_en_publico = document.getElementById('categoria-visible-publico').checked ? 1 : 0;
            } catch (e) {
                data.visible_en_publico = 1;
            }

            // Incluir marca de categoria predeterminada en domicilios
            try {
                data.default_en_domicilio = document.getElementById('categoria-default-domicilio').checked ? 1 : 0;
            } catch (e) {
                data.default_en_domicilio = 0;
            }

            try {
                const url = id ? `${API_BASE_URL}/api/categorias-config/${id}` : `${API_BASE_URL}/api/categorias-config`;
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    mostrarNotificacion(id ? 'Categoria actualizada' : 'Categoria creada', 'success');
                    cerrarModal('modal-categoria');
                    cargarCategorias();
                } else {
                    mostrarNotificacion(result.error || 'Error al guardar categoria', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al guardar categoria', 'error');
            }
        }

        async function eliminarCategoria(id) {
            if (!confirm('Â¿Estas seguro de eliminar esta categoria? No se puede eliminar si tiene productos asociados.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/categorias-config/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    mostrarNotificacion('Categoria eliminada', 'success');
                    cargarCategorias();
                } else {
                    mostrarNotificacion(result.error || 'Error al eliminar categoria', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al eliminar categoria', 'error');
            }
        }

        async function toggleVisiblePublico(catId, current) {
            // Alterna la visibilidad publica de una categoria (1 visible, 0 oculta)
            try {
                const nuevo = current && current != 0 ? 0 : 1;
                const resp = await fetch(`${API_BASE_URL}/api/categorias-config/${catId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ visible_en_publico: nuevo })
                });

                if (resp.ok) {
                    mostrarNotificacion(nuevo ? 'Categoria ahora visible en publico' : 'Categoria ocultada del menu publico', 'success');
                    cargarCategorias();
                } else {
                    const data = await resp.json();
                    mostrarNotificacion(data.error || 'No se pudo actualizar visibilidad', 'error');
                }
            } catch (e) {
                console.error('Error toggling visible_en_publico:', e);
                mostrarNotificacion('Error al cambiar visibilidad', 'error');
            }
        }

        async function confirmarLimpiarMenu() {
            const confirmacion = prompt('Esta accion eliminara TODAS las categorias y productos. Escribe "ELIMINAR TODO" para confirmar:');

            if (confirmacion === 'ELIMINAR TODO') {
                try {
                    const response = await fetch(API_BASE_URL + '/api/limpiar-menu', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ confirmar: true })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        mostrarNotificacion('Menu limpiado exitosamente', 'success');
                        cargarCategorias();
                        cargarProductos();
                    } else {
                        mostrarNotificacion(result.error || 'Error al limpiar menu', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    mostrarNotificacion('Error al limpiar menu', 'error');
                }
            } else if (confirmacion !== null) {
                mostrarNotificacion('Accion cancelada', 'info');
            }
        }

        // ==================== PRODUCTOS ====================
        async function cargarProductos() {
            try {
                const response = await fetch(API_BASE_URL + '/api/categorias-config');
                categoriasData = await response.json();

                // Cargar productos de todas las categorias
                productosData = [];
                for (const cat of categoriasData) {
                    const resp = await fetch(`${API_BASE_URL}/api/productos-categoria/${cat.id}`);
                    const prods = await resp.json();
                    productosData = productosData.concat(prods);
                }

                mostrarProductos();
            } catch (error) {
                console.error('Error cargando productos:', error);
                mostrarNotificacion('Error al cargar productos', 'error');
            }
        }

        function mostrarProductos(filtro = '', filtroSubcategoria = '') {
            const lista = document.getElementById('lista-productos');
            let productosFiltrados = productosData;

            if (filtro) {
                productosFiltrados = productosData.filter(p => p.categoria_id == filtro);
            }

            // Aplicar filtro de subcategoria si es categoria de bebidas
            if (filtroSubcategoria && filtro) {
                const categoria = categoriasData.find(c => c.id == filtro);
                if (categoria && categoria.nombre.toLowerCase().includes('bebida')) {
                    productosFiltrados = productosFiltrados.filter(p =>
                        (p.tipo_bebida && p.tipo_bebida.toLowerCase() === filtroSubcategoria.toLowerCase()) ||
                        (p.subcategoria_nombre && p.subcategoria_nombre.toLowerCase() === filtroSubcategoria.toLowerCase())
                    );
                } else if (categoria) {
                    // Para otras categorias, filtrar por subcategoria normal
                    productosFiltrados = productosFiltrados.filter(p =>
                        p.subcategoria_id && p.subcategoria_id == filtroSubcategoria
                    );
                }
            }

            if (productosFiltrados.length === 0) {
                lista.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-box-open text-6xl text-gray-600 mb-4"></i>
                        <p class="text-xl text-gray-400">No hay productos</p>
                    </div>
                `;
                return;
            }

            lista.innerHTML = productosFiltrados.map(prod => {
                const preciosHTML = prod.precios && prod.precios.length > 0
                    ? prod.precios.map(p => `<div class="text-sm"><span class="font-semibold">${p.nombre_precio}:</span> $${p.precio}</div>`).join('')
                    : '<div class="text-sm text-gray-500">Sin precios</div>';

                const stockInfo = prod.inventario
                    ? `<span class="text-sm ${prod.inventario.stock_actual <= prod.inventario.stock_minimo ? 'text-red-400' : 'text-green-400'}">
                        Stock: ${prod.inventario.stock_actual || 0}
                      </span>`
                    : '';

                const subcategoriaInfo = prod.subcategoria_nombre ? `<span class="text-xs bg-blue-600 px-2 py-1 rounded ml-2">${prod.subcategoria_nombre}</span>` : (prod.tipo_bebida ? `<span class="text-xs bg-green-600 px-2 py-1 rounded ml-2">${prod.tipo_bebida}</span>` : '');

                return `
                    <div class="bg-slate-800 rounded-lg p-6 card-hover">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h3 class="text-lg font-bold">${prod.nombre}</h3>
                                <p class="text-sm text-gray-400">${prod.categoria_nombre || 'Sin categoria'}${subcategoriaInfo}</p>
                            </div>
                            ${stockInfo}
                        </div>

                        <p class="text-sm text-gray-300 mb-3">${prod.descripcion || 'Sin descripcion'}</p>

                        <div class="mb-4 p-3 bg-slate-700 rounded">
                            <p class="font-semibold text-sm mb-2">Precios:</p>
                            ${preciosHTML}
                        </div>

                        <div class="flex space-x-2">
                            <button onclick="editarProducto(${prod.id})" class="flex-1 bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded text-sm transition">
                                <i class="fas fa-edit mr-1"></i>Editar
                            </button>
                            <button onclick="eliminarProducto(${prod.id})" class="flex-1 bg-red-600 hover:bg-red-700 px-3 py-2 rounded text-sm transition">
                                <i class="fas fa-trash mr-1"></i>Eliminar
                            </button>
                            <button onclick="abrirModalAsignar(${prod.id})" class="flex-1 bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded transition">
                                <i class="fas fa-cogs mr-2"></i>Configurar Opciones
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filtrarProductos() {
            const filtro = document.getElementById('filtro-categoria').value;
            const filtroSubcategoria = document.getElementById('filtro-subcategoria').value;
            mostrarProductos(filtro, filtroSubcategoria);
        }



        function actualizarFiltrosSubcategoria() {
            const categoriaId = document.getElementById('filtro-categoria').value;
            const subcategoriaSelect = document.getElementById('filtro-subcategoria');

            // Limpiar filtros anteriores
            subcategoriaSelect.innerHTML = '<option value="">Todas las subcategorias</option>';

            if (!categoriaId) {
                subcategoriaSelect.style.display = 'none';
                return;
            }

            // Verificar si es categoria de bebidas
            const categoria = categoriasData.find(c => c.id == categoriaId);
            if (categoria && categoria.nombre.toLowerCase().includes('bebida')) {
                // Mostrar filtro de subcategorias para bebidas
                subcategoriaSelect.style.display = 'block';

                // Mostrar subcategorias fijas para bebidas
                const subcategoriasBebidas = ['gaseosa', 'limonada', 'jugo', 'agua'];
                subcategoriasBebidas.forEach(subcat => {
                    const option = document.createElement('option');
                    option.value = subcat;
                    option.textContent = subcat.charAt(0).toUpperCase() + subcat.slice(1) + 's';
                    subcategoriaSelect.appendChild(option);
                });
            } else {
                subcategoriaSelect.style.display = 'none';
            }

            filtrarProductos();
        }

        async function cargarCategoriasEnSelect() {
            const select = document.getElementById('producto-categoria');
            const filtro = document.getElementById('filtro-categoria');

            const options = categoriasData.filter(c => c.activo).map(cat =>
                `<option value="${cat.id}">${cat.nombre}</option>`
            ).join('');

            select.innerHTML = '<option value="">Selecciona una categoria</option>' + options;
            filtro.innerHTML = '<option value="">Todas las categorias</option>' + options;
        }

        function abrirModalProducto() {
            productoActual = null;
            document.getElementById('titulo-modal-producto').textContent = 'Nuevo Producto';
            document.getElementById('form-producto').reset();
            document.getElementById('producto-id').value = '';
            document.getElementById('producto-imagen').value = '';
            document.getElementById('lista-precios').innerHTML = '';
            document.getElementById('campos-dinamicos-producto').innerHTML = '';
            preciosContador = 0;
            // Limpiar preview de imagen anterior
            const existingPreview = document.querySelector('#producto-imagen').parentNode.querySelector('.mt-2');
            if (existingPreview) existingPreview.remove();
            abrirModal('modal-producto');
            cargarCategoriasEnSelect();
        }

        function actualizarCamposProducto() {
            const categoriaId = document.getElementById('producto-categoria').value;
            const divSubcategoria = document.getElementById('div-subcategoria');

            if (!categoriaId) {
                document.getElementById('campos-dinamicos-producto').innerHTML = '';
                if (divSubcategoria) divSubcategoria.style.display = 'none';
                return;
            }

            const categoria = categoriasData.find(c => c.id == categoriaId);
            if (!categoria) return;

            // Mostrar/ocultar subcategorias
            if (categoria.subcategorias && categoria.subcategorias.length > 0) {
                const selectSubcategoria = document.getElementById('producto-subcategoria');
                selectSubcategoria.innerHTML = '<option value="">Selecciona una subcategoria (opcional)</option>' +
                    categoria.subcategorias.map(sub => `<option value="${sub.id}">${sub.nombre}</option>`).join('');
                divSubcategoria.style.display = 'block';
            } else if (categoria.nombre.toLowerCase().includes('bebida')) {
                // Para bebidas, mostrar subcategorias dinamicas
                const selectSubcategoria = document.getElementById('producto-subcategoria');
                selectSubcategoria.innerHTML = '<option value="">Selecciona una subcategoria (opcional)</option>' +
                    '<option value="gaseosa">Gaseosa</option>' +
                    '<option value="limonada">Limonada</option>' +
                    '<option value="jugo">Jugo Natural</option>' +
                    '<option value="agua">Agua</option>' +
                    '<option value="te">Te</option>' +
                    '<option value="energizante">Energizante</option>' +
                    '<option value="cerveza">Cerveza</option>' +
                    '<option value="vino">Vino</option>';
                divSubcategoria.style.display = 'block';
            } else {
                divSubcategoria.style.display = 'none';
            }

            let html = '';

            if (categoria.campos_requeridos.ingredientes) {
                html += `
                    <div class="bg-slate-700 p-4 rounded-lg mb-4">
                        <label class="block font-medium mb-2">Ingredientes</label>
                        <textarea id="producto-ingredientes" rows="3" placeholder="Ej: Queso mozzarella, tomate, jamon..." class="w-full px-4 py-2 bg-slate-600 rounded-lg border border-slate-500 focus:border-blue-500 focus:outline-none"></textarea>
                    </div>
                `;
            }

            if (categoria.campos_requeridos.mililitros) {
                html += `
                    <div class="bg-slate-700 p-4 rounded-lg mb-4">
                        <label class="block font-medium mb-2">Â¿Es jugo natural?</label>
                        <label class="flex items-center">
                            <input type="checkbox" id="es-jugo-natural" class="mr-2 w-5 h-5">
                            <span class="text-sm">Marcar si es jugo natural (no requiere mililitros especificos)</span>
                        </label>
                    </div>
                `;
            }

            document.getElementById('campos-dinamicos-producto').innerHTML = html;

            // Limpiar y agregar un precio inicial
            document.getElementById('lista-precios').innerHTML = '';
            agregarPrecio();
        }

        function agregarPrecio() {
            const categoriaId = document.getElementById('producto-categoria').value;
            if (!categoriaId) {
                mostrarNotificacion('Primero selecciona una categoria', 'warning');
                return;
            }

            const categoria = categoriasData.find(c => c.id == categoriaId);
            const lista = document.getElementById('lista-precios');

            let nombreLabel = 'Nombre';
            let valorLabel = '';
            let placeholder = '';

            if (categoria.campos_requeridos.tamanos) {
                nombreLabel = 'Tamanio';
                placeholder = 'Ej: Personal, Mediano, Grande';
            } else if (categoria.campos_requeridos.mililitros) {
                const esJugo = document.getElementById('es-jugo-natural')?.checked;
                if (!esJugo) {
                    valorLabel = '<div><label class="block text-sm mb-1">Mililitros</label><input type="number" class="precio-valor-numerico w-full px-3 py-2 bg-slate-600 rounded border border-slate-500" placeholder="Ej: 300, 500, 1000"></div>';
                }
                nombreLabel = 'Nombre';
                placeholder = 'Ej: Coca Cola 500ml, Jugo Natural';
            } else {
                placeholder = 'Ej: Precio unico, Porcion individual';
            }

            const html = `
                <div class="bg-slate-700 p-3 rounded-lg flex gap-3 items-end" data-precio-id="${preciosContador}">
                    <div class="flex-1">
                        <label class="block text-sm mb-1">${nombreLabel}</label>
                        <input type="text" class="precio-nombre w-full px-3 py-2 bg-slate-600 rounded border border-slate-500" placeholder="${placeholder}" required>
                    </div>
                    ${valorLabel}
                    <div class="flex-1">
                        <label class="block text-sm mb-1">Precio ($)</label>
                        <input type="number" class="precio-valor w-full px-3 py-2 bg-slate-600 rounded border border-slate-500" step="0.01" min="0" required>
                    </div>
                    <button type="button" onclick="this.parentElement.remove()" class="bg-red-600 hover:bg-red-700 px-3 py-2 rounded">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;

            lista.insertAdjacentHTML('beforeend', html);
            preciosContador++;
        }

        async function guardarProducto(event) {
            event.preventDefault();

            const id = document.getElementById('producto-id').value;
            const categoriaId = document.getElementById('producto-categoria').value;

            // Recopilar precios
            const preciosElements = document.querySelectorAll('#lista-precios > div');
            if (preciosElements.length === 0) {
                mostrarNotificacion('Debes agregar al menos un precio', 'warning');
                return;
            }

            const precios = [];
            preciosElements.forEach(el => {
                const nombre = el.querySelector('.precio-nombre').value;
                const precio = parseFloat(el.querySelector('.precio-valor').value);
                const valorNumericoEl = el.querySelector('.precio-valor-numerico');
                const valorNumerico = valorNumericoEl ? parseFloat(valorNumericoEl.value) : null;

                precios.push({
                    nombre: nombre,
                    precio: precio,
                    valor_numerico: valorNumerico
                });
            });

            // Recopilar atributos adicionales
            const atributos = {};
            const ingredientesEl = document.getElementById('producto-ingredientes');
            if (ingredientesEl) {
                atributos.ingredientes = ingredientesEl.value;
            }
            const esJugoEl = document.getElementById('es-jugo-natural');
            if (esJugoEl) {
                atributos.es_jugo_natural = esJugoEl.checked;
            }

            // Manejar la imagen
            const imagenInput = document.getElementById('producto-imagen');
            let formData = new FormData();

            // Agregar datos basicos
            formData.append('nombre', document.getElementById('producto-nombre').value);
            formData.append('descripcion', document.getElementById('producto-descripcion').value);
            formData.append('categoria_id', categoriaId);

            // Agregar tipo_bebida a atributos si es una bebida
            const tipoBebida = document.getElementById('producto-subcategoria').value;
            if (tipoBebida) {
                atributos.tipo_bebida = tipoBebida;
            }

            formData.append('subcategoria_id', tipoBebida || null);
            formData.append('stock_minimo', parseFloat(document.getElementById('producto-stock-minimo').value));
            formData.append('precios', JSON.stringify(precios));
            formData.append('atributos', JSON.stringify(atributos));
            formData.append('crear_inventario', 'true');

            // Agregar imagen si existe
            if (imagenInput.files && imagenInput.files[0]) {
                const file = imagenInput.files[0];
                // Validar tamanio (maximo 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    mostrarNotificacion('La imagen no puede ser mayor a 5MB', 'error');
                    return;
                }
                // Validar tipo
                if (!file.type.startsWith('image/')) {
                    mostrarNotificacion('Solo se permiten archivos de imagen', 'error');
                    return;
                }

                formData.append('imagen', file);
            }

            try {
                const url = id ? `${API_BASE_URL}/api/productos-dinamico/${id}` : `${API_BASE_URL}/api/productos-dinamico`;
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    body: formData  // Enviar FormData en lugar de JSON
                });

                const result = await response.json();

                if (response.ok) {
                    mostrarNotificacion(id ? 'Producto actualizado' : 'Producto creado', 'success');
                    cerrarModal('modal-producto');
                    cargarProductos();
                } else {
                    mostrarNotificacion(result.error || 'Error al guardar producto', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al guardar producto', 'error');
            }
        }

        async function editarProducto(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/productos-dinamico/${id}`);
                const producto = await response.json();

                productoActual = producto;
                document.getElementById('titulo-modal-producto').textContent = 'Editar Producto';
                document.getElementById('producto-id').value = producto.id;
                document.getElementById('producto-nombre').value = producto.nombre;
                document.getElementById('producto-descripcion').value = producto.descripcion || '';
                document.getElementById('producto-categoria').value = producto.categoria_id;
                document.getElementById('producto-stock-minimo').value = producto.inventario?.stock_minimo || 10;

                // Actualizar campos dinamicos
                actualizarCamposProducto();

                // Cargar subcategoria
                if (producto.subcategoria_id) {
                    document.getElementById('producto-subcategoria').value = producto.subcategoria_id;
                } else if (producto.tipo_bebida) {
                    document.getElementById('producto-subcategoria').value = producto.tipo_bebida;
                }

                // Cargar atributos
                if (producto.atributos && Array.isArray(producto.atributos)) {
                    producto.atributos.forEach(attr => {
                        const el = document.getElementById(`producto-${attr.atributo_nombre}`);
                        if (el) {
                            if (el.type === 'checkbox') {
                                el.checked = attr.atributo_valor === 'true';
                            } else {
                                el.value = attr.atributo_valor;
                            }
                        }
                    });
                } else {
                    // Si no hay atributos, intentar cargar desde campos individuales
                    const ingredientesEl = document.getElementById('producto-ingredientes');
                    if (ingredientesEl && producto.ingredientes) {
                        ingredientesEl.value = producto.ingredientes;
                    }
                    const esJugoEl = document.getElementById('es-jugo-natural');
                    if (esJugoEl && producto.es_jugo_natural !== undefined) {
                        esJugoEl.checked = producto.es_jugo_natural;
                    }
                }

                // Cargar imagen si existe
                if (producto.imagen_url) {
                    // Mostrar preview de la imagen existente
                    const imagenInput = document.getElementById('producto-imagen');
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'mt-2';
                    previewDiv.innerHTML = `
                        <p class="text-sm text-gray-400 mb-2">Imagen actual:</p>
                        <img src="${producto.imagen_url}" alt="Imagen actual" class="max-w-32 max-h-32 object-cover rounded border border-slate-600">
                    `;
                    imagenInput.parentNode.appendChild(previewDiv);
                }

                // Cargar precios
                document.getElementById('lista-precios').innerHTML = '';
                if (producto.precios && producto.precios.length > 0) {
                    producto.precios.forEach(precio => {
                        // Intentar agregar usando la funcion existente
                        try {
                            agregarPrecio();
                        } catch (e) {
                            console.warn('agregarPrecio fallo:', e);
                        }

                        const lastAdded = document.querySelector('#lista-precios > div:last-child');

                        if (lastAdded) {
                            const nombreEl = lastAdded.querySelector('.precio-nombre');
                            const valorEl = lastAdded.querySelector('.precio-valor');
                            const valorNumericoEl = lastAdded.querySelector('.precio-valor-numerico');

                            if (nombreEl) nombreEl.value = precio.nombre_precio || '';
                            if (valorEl) valorEl.value = precio.precio ?? '';
                            if (valorNumericoEl && precio.valor_numerico !== undefined && precio.valor_numerico !== null) {
                                valorNumericoEl.value = precio.valor_numerico;
                            }
                        } else {
                            // Fallback: si por alguna razon no se agrego el elemento, crear uno manualmente
                            const lista = document.getElementById('lista-precios');
                            const nombreVal = precio.nombre_precio || '';
                            const precioVal = precio.precio ?? '';
                            const valorNum = precio.valor_numerico !== undefined && precio.valor_numerico !== null ? precio.valor_numerico : '';

                            const fallbackHtml = `
                                <div class="bg-slate-700 p-3 rounded-lg flex gap-3 items-end" data-precio-id="fallback-${Date.now()}">
                                    <div class="flex-1">
                                        <label class="block text-sm mb-1">Nombre</label>
                                        <input type="text" class="precio-nombre w-full px-3 py-2 bg-slate-600 rounded border border-slate-500" value="${nombreVal}" required>
                                    </div>
                                    <div class="flex-1">
                                        <label class="block text-sm mb-1">Precio ($)</label>
                                        <input type="number" class="precio-valor w-full px-3 py-2 bg-slate-600 rounded border border-slate-500" step="0.01" min="0" value="${precioVal}" required>
                                    </div>
                                    <button type="button" onclick="this.parentElement.remove()" class="bg-red-600 hover:bg-red-700 px-3 py-2 rounded">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                            lista.insertAdjacentHTML('beforeend', fallbackHtml);
                        }
                    });
                }

                abrirModal('modal-producto');
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al cargar producto', 'error');
            }
        }

        async function eliminarProducto(id) {
            if (!confirm('Â¿Estas seguro de eliminar este producto? Tambien se eliminara su inventario asociado.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/productos-dinamico/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    mostrarNotificacion('Producto eliminado', 'success');
                    cargarProductos();
                } else {
                    mostrarNotificacion(result.error || 'Error al eliminar producto', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al eliminar producto', 'error');
            }
        }


        // ==================== DOS SABORES ====================
        let productoDosSaboresSeleccionado = null;
        let saboresConfigurados = [];

        async function cargarCategoriasEnSelectDosSabores() {
            try {
                const response = await fetch(API_BASE_URL + '/api/categorias-config');
                const categorias = await response.json();

                const select = document.getElementById('filtro-categoria-dos-sabores');
                select.innerHTML = '<option value="">Todas las categorias</option>';

                categorias.forEach(cat => {
                    select.innerHTML += `<option value="${cat.id}">${cat.nombre}</option>`;
                });
            } catch (error) {
                console.error('Error cargando categorias:', error);
            }
        }

        async function cargarProductosDosSabores() {
            const categoriaId = document.getElementById('filtro-categoria-dos-sabores')?.value || '';

            try {
                let url = API_BASE_URL + '/api/productos';
                if (categoriaId) {
                    url += `?categoria_id=${categoriaId}`;
                }

                const response = await fetch(url);
                const productos = await response.json();

                const container = document.getElementById('lista-productos-dos-sabores');

                if (productos.length === 0) {
                    container.innerHTML = '<p class="text-gray-400 text-center py-4">No hay productos</p>';
                    return;
                }

                container.innerHTML = productos.map(p => `
                    <div class="flex items-center justify-between p-3 bg-slate-700 rounded-lg cursor-pointer hover:bg-slate-600 transition ${productoDosSaboresSeleccionado?.id === p.id ? 'ring-2 ring-blue-500' : ''}"
                         onclick="seleccionarProductoDosSabores(${p.id}, '${p.nombre.replace(/'/g, "\\'")}', ${p.permite_dos_sabores || 0}, ${p.permite_tres_sabores || 0})">
                        <div class="flex items-center gap-3">
                            ${p.imagen_url ?
                        `<img src="${p.imagen_url}" class="w-10 h-10 rounded object-cover">` :
                        `<div class="w-10 h-10 rounded bg-slate-600 flex items-center justify-center"><i class="fas fa-image text-gray-500"></i></div>`
                    }
                            <div>
                                <p class="font-semibold">${p.nombre}</p>
                                <p class="text-xs text-gray-400">${p.categoria_nombre || 'Sin categoria'}</p>
                            </div>
                        </div>
                        <div>
                            ${p.permite_dos_sabores ?
                        '<span class="bg-green-600 text-xs px-2 py-1 rounded-full"><i class="fas fa-check mr-1"></i>2 Sabores</span>' :
                        '<span class="bg-slate-600 text-xs px-2 py-1 rounded-full">Normal</span>'
                    }
                            ${p.permite_tres_sabores ? '<span class="ml-2 bg-emerald-600 text-xs px-2 py-1 rounded-full">3 Sabores</span>' : ''}
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error cargando productos:', error);
                document.getElementById('lista-productos-dos-sabores').innerHTML =
                    '<p class="text-red-400 text-center py-4">Error al cargar productos</p>';
            }
        }

        async function seleccionarProductoDosSabores(productoId, nombre, permiteDosSabores, permiteTresSabores) {
            productoDosSaboresSeleccionado = { id: productoId, nombre: nombre };

            // Mostrar config y ocultar placeholder
            document.getElementById('config-sabores-producto').classList.remove('hidden');
            document.getElementById('placeholder-config-sabores').classList.add('hidden');

            // Actualizar nombre
            document.getElementById('nombre-producto-sabores').textContent = nombre;

            // Actualizar checkbox
            document.getElementById('toggle-permite-dos-sabores').checked = permiteDosSabores;
            const toggleTres = document.getElementById('toggle-permite-tres-sabores');
            if (toggleTres) toggleTres.checked = permiteTresSabores;

            // Mostrar/ocultar seccion de sabores
            if (permiteDosSabores) {
                document.getElementById('seccion-agregar-sabores').classList.remove('hidden');
                await cargarSaboresProducto(productoId);
                await cargarProductosParaSabores();
            } else {
                document.getElementById('seccion-agregar-sabores').classList.add('hidden');
            }

            // Actualizar visual en lista
            cargarProductosDosSabores();
        }

        async function togglePermiteDosSabores() {
            if (!productoDosSaboresSeleccionado) return;

            const permite = document.getElementById('toggle-permite-dos-sabores').checked;

            try {
                const response = await fetch(API_BASE_URL + `/api/productos/${productoDosSaboresSeleccionado.id}/toggle-dos-sabores`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ permite_dos_sabores: permite })
                });

                if (response.ok) {
                    if (permite) {
                        document.getElementById('seccion-agregar-sabores').classList.remove('hidden');
                        await cargarSaboresProducto(productoDosSaboresSeleccionado.id);
                        await cargarProductosParaSabores();
                    } else {
                        document.getElementById('seccion-agregar-sabores').classList.add('hidden');
                    }
                    cargarProductosDosSabores();
                    mostrarNotificacion(permite ? 'Dos sabores activado' : 'Dos sabores desactivado', 'success');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al actualizar', 'error');
            }
        }

        async function togglePermiteTresSabores() {
            if (!productoDosSaboresSeleccionado) return;

            const permite = document.getElementById('toggle-permite-tres-sabores').checked;

            try {
                const response = await fetch(API_BASE_URL + `/api/productos/${productoDosSaboresSeleccionado.id}/toggle-tres-sabores`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ permite_tres_sabores: permite })
                });

                if (response.ok) {
                    mostrarNotificacion(permite ? 'Tres sabores activado' : 'Tres sabores desactivado', 'success');
                    // actualizar lista y datos
                    await cargarSaboresProducto(productoDosSaboresSeleccionado.id);
                    cargarProductosDosSabores();
                } else {
                    const data = await response.json();
                    mostrarNotificacion(data.error || 'Error al actualizar', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al actualizar', 'error');
            }
        }

        async function cargarSaboresProducto(productoId) {
            try {
                const response = await fetch(API_BASE_URL + `/api/productos/${productoId}/sabores`);
                saboresConfigurados = await response.json();
                // Normalizar respuesta: asegurar que `saboresConfigurados` sea un array
                if (!Array.isArray(saboresConfigurados)) {
                    if (Array.isArray(saboresConfigurados.data)) {
                        saboresConfigurados = saboresConfigurados.data;
                    } else if (saboresConfigurados && typeof saboresConfigurados === 'object' && Object.values(saboresConfigurados).every(v => v && v.id)) {
                        // Si la API devolviera un objeto indexado, convertir a array
                        saboresConfigurados = Object.values(saboresConfigurados);
                    } else {
                        // No es un array conocido -> vaciar
                        console.warn('Respuesta de sabores no es un array, normalizando a array vacío:', saboresConfigurados);
                        saboresConfigurados = [];
                    }
                }
                console.log('Sabores configurados cargados:', saboresConfigurados);

                const container = document.getElementById('lista-sabores-configurados');

                if (saboresConfigurados.length === 0) {
                    container.innerHTML = '<p class="text-gray-400 text-sm">No hay sabores configurados</p>';
                    return;
                }

                container.innerHTML = saboresConfigurados.map(s => `
                    <div class="flex items-center justify-between p-2 bg-slate-600 rounded">
                        <div class="flex items-center gap-2">
                            ${s.imagen_url ?
                        `<img src="${s.imagen_url}" class="w-8 h-8 rounded object-cover">` :
                        `<div class="w-8 h-8 rounded bg-slate-500 flex items-center justify-center"><i class="fas fa-pizza-slice text-xs"></i></div>`
                    }
                            <span>${s.nombre}</span>
                        </div>
                        <button onclick="eliminarSaborProducto(${s.id})" class="text-red-400 hover:text-red-300">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error cargando sabores:', error);
            }
        }

        async function cargarProductosParaSabores() {
            try {
                const response = await fetch(API_BASE_URL + '/api/productos');
                const productos = await response.json();

                const select = document.getElementById('select-nuevo-sabor');
                select.innerHTML = '<option value="">Selecciona un producto como sabor</option>';

                // Filtrar productos que ya estan agregados
                // Normalizar los posibles campos que indican el id del producto sabor
                const idsAgregados = Array.isArray(saboresConfigurados) ? saboresConfigurados.map(s => (s.sabor_producto_id ?? s.producto_id ?? s.id ?? null)).filter(Boolean) : [];

                // Debug: mostrar resumen para entender por qué ciertos productos no aparecen
                console.log('Productos totales disponibles para sabores:', productos.length);
                console.log('IDs ya agregados como sabores:', idsAgregados);
                console.log('Primeros 10 productos (id, nombre, categoria):', productos.slice(0, 10).map(p => ({ id: p.id, nombre: p.nombre, categoria: p.categoria_nombre })));

                productos
                    .filter(p => p.id !== productoDosSaboresSeleccionado?.id && !idsAgregados.includes(p.id))
                    .forEach(p => {
                        select.innerHTML += `<option value="${p.id}">${p.nombre} (${p.categoria_nombre || 'Sin cat.'})</option>`;
                    });

            } catch (error) {
                console.error('Error cargando productos para sabores:', error);
            }
        }

        async function agregarSaborProducto() {
            if (!productoDosSaboresSeleccionado) return;

            const saborId = document.getElementById('select-nuevo-sabor').value;
            if (!saborId) {
                mostrarNotificacion('Selecciona un sabor', 'warning');
                return;
            }

            try {
                const response = await fetch(API_BASE_URL + `/api/productos/${productoDosSaboresSeleccionado.id}/sabores`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sabor_producto_id: parseInt(saborId) })
                });

                if (response.ok) {
                    mostrarNotificacion('Sabor agregado', 'success');
                    await cargarSaboresProducto(productoDosSaboresSeleccionado.id);
                    await cargarProductosParaSabores();
                } else {
                    const data = await response.json();
                    mostrarNotificacion(data.error || 'Error al agregar', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al agregar sabor', 'error');
            }
        }

        async function eliminarSaborProducto(saborId) {
            if (!productoDosSaboresSeleccionado) return;

            if (!confirm('Â¿Eliminar este sabor?')) return;

            try {
                const response = await fetch(API_BASE_URL + `/api/productos/${productoDosSaboresSeleccionado.id}/sabores/${saborId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    mostrarNotificacion('Sabor eliminado', 'success');
                    await cargarSaboresProducto(productoDosSaboresSeleccionado.id);
                    await cargarProductosParaSabores();
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al eliminar', 'error');
            }
        }



        // ==================== INVENTARIO ====================
        async function cargarInventario() {
            try {
                // Cargar todos los productos directamente
                const response = await fetch(API_BASE_URL + '/api/productos');
                const productos = await response.json();

                mostrarInventario(productos);
            } catch (error) {
                console.error('Error cargando inventario:', error);
                mostrarNotificacion('Error al cargar inventario', 'error');
            }
        }

        function mostrarInventario(productos) {
            const tbody = document.getElementById('tabla-inventario-body');

            if (productos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">No hay productos en inventario</td></tr>';
                return;
            }

            tbody.innerHTML = productos.map(prod => {
                const stockActual = prod.stock_actual || 0;
                const stockMinimo = prod.stock_minimo || 0;
                const estado = stockActual <= stockMinimo && stockMinimo > 0;

                return `
                    <tr class="border-b border-slate-700 hover:bg-slate-750">
                        <td class="py-3 px-4" data-label="Producto">${prod.nombre}</td>
                        <td class="py-3 px-4 text-gray-400" data-label="Categoria">${prod.categoria_nombre || 'N/A'}</td>
                        <td class="py-3 px-4 text-center font-semibold ${estado ? 'text-red-400' : 'text-green-400'}" data-label="Stock Actual">${stockActual} ${prod.unidad_medida || 'und'}</td>
                        <td class="py-3 px-4 text-center text-gray-400" data-label="Stock Minimo">${stockMinimo}</td>
                        <td class="py-3 px-4 text-center" data-label="Estado">
                            ${estado
                        ? '<span class="bg-red-900 text-red-200 px-3 py-1 rounded-full text-xs">⚠️ Stock Bajo</span>'
                        : '<span class="bg-green-900 text-green-200 px-3 py-1 rounded-full text-xs">✔ OK</span>'}
                        </td>
                        <td class="py-3 px-4 text-center" data-label="Acciones">
                            <button onclick="abrirModalStock(${prod.id}, '${prod.nombre}', ${stockActual}, ${stockMinimo})" class="bg-blue-600 hover:bg-blue-700 px-4 py-1 rounded text-sm">
                                Actualizar
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function abrirModalStock(productoId, productoNombre, stockActual, stockMinimo) {
            document.getElementById('stock-producto-id').value = productoId;
            document.getElementById('stock-producto-nombre').textContent = productoNombre;
            document.getElementById('stock-actual').value = stockActual;
            abrirModal('modal-stock');
        }

        async function actualizarStock(event) {
            event.preventDefault();

            const productoId = document.getElementById('stock-producto-id').value;
            const stockActual = parseFloat(document.getElementById('stock-actual').value);

            try {
                const response = await fetch(`${API_BASE_URL}/api/inventario-producto/${productoId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stock_actual: stockActual })
                });

                const result = await response.json();

                if (response.ok) {
                    mostrarNotificacion('Stock actualizado', 'success');
                    cerrarModal('modal-stock');
                    cargarInventario();
                } else {
                    mostrarNotificacion(result.error || 'Error al actualizar stock', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al actualizar stock', 'error');
            }
        }

        // ==================== UTILIDADES ====================
        function abrirModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        // Actualiza el preview del icono en el formulario de categoria
        function updateIconPreview() {
            const sel = document.getElementById('categoria-icono');
            const preview = document.getElementById('categoria-icono-preview');
            if (!sel || !preview) return;
            const cls = sel.value || 'fas fa-tag';
            preview.innerHTML = `<i class="${cls}"></i>`;
        }

        function cerrarModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                // Forzar reflow para asegurar que el modal se cierre correctamente
                void modal.offsetWidth;
            }
        }

        function mostrarNotificacion(mensaje, tipo = 'info') {
            // Usar el sistema de notificaciones existente
            if (typeof showNotification === 'function') {
                showNotification(mensaje, tipo);
            } else {
                // Fallback simple
                alert(mensaje);
            }
        }


        // ==================== VINCULACIONES ====================
        async function cargarVinculaciones() {
            try {
                const response = await fetch(API_BASE_URL + '/api/productos/vinculaciones');
                const vinculaciones = await response.json();

                mostrarVinculaciones(vinculaciones);
                cargarProductosEnSelects();
            } catch (error) {
                console.error('Error cargando vinculaciones:', error);
                mostrarNotificacion('Error al cargar vinculaciones', 'error');
            }
        }

        function mostrarVinculaciones(vinculaciones) {
            const container = document.getElementById('vinculaciones-activas');

            if (!vinculaciones || vinculaciones.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-400">
                        <i class="fas fa-link text-4xl mb-4 text-gray-600"></i>
                        <p class="text-lg">No hay vinculaciones configuradas</p>
                        <p class="text-sm">Crea tu primera vinculacion para combinar productos</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = vinculaciones.map(vinc => {
                // Compatibilidad: la API puede devolver estructura anidada o campos planos
                const principal = vinc.producto_principal || {};
                const adicional = vinc.producto_adicional || {};
                const principalNombre = principal.nombre || vinc.producto_principal_nombre || 'Producto principal';
                const adicionalNombre = adicional.nombre || vinc.producto_adicional_nombre || vinc.producto_vinculado_nombre || 'Producto adicional';
                const tipo = vinc.tipo_vinculacion || vinc.tipo || 'adicional';
                const obligatorio = vinc.obligatorio === 1 || vinc.obligatorio === true;
                // Precio puede venir como precio_fijo o precio_adicional segun endpoint/cliente
                const precio = (vinc.precio_fijo !== undefined && vinc.precio_fijo !== null) ? vinc.precio_fijo : (vinc.precio_adicional || 0);

                return `
                <div class="bg-slate-700 rounded-lg p-4 border border-slate-600">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="font-semibold text-green-400">${principalNombre}</span>
                                <i class="fas fa-arrow-right text-gray-400"></i>
                                <span class="font-semibold text-blue-400">${adicionalNombre}</span>
                            </div>
                            <div class="flex items-center gap-4 text-sm text-gray-400">
                                <span><i class="fas fa-tag mr-1"></i>${tipo}</span>
                                ${obligatorio ? '<span class="text-red-400"><i class="fas fa-exclamation-triangle mr-1"></i>Obligatorio</span>' : ''}
                                ${precio > 0 ? `<span class="text-green-400">+ $${formatPrice(precio)}</span>` : ''}
                            </div>
                        </div>
                        <button onclick="eliminarVinculacion(${vinc.id})" class="text-red-400 hover:text-red-300 ml-4">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            }).join('');
        }

        let todosLosProductos = [];

        async function cargarProductosEnSelects() {
            try {
                const response = await fetch(API_BASE_URL + '/api/productos');
                todosLosProductos = await response.json();

                const selectPrincipal = document.getElementById('vinculacion-producto-principal');
                const options = todosLosProductos.map(p => `<option value="${p.id}">${p.nombre} (${p.categoria_nombre})</option>`).join('');
                selectPrincipal.innerHTML = '<option value="">Selecciona producto principal</option>' + options;

                filtrarProductosVinculados();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function filtrarProductosVinculados() {
            const tipo = document.getElementById('vinculacion-tipo').value;
            const filtroSubcategoria = document.getElementById('vinculacion-filtro-subcategoria').value;
            const divFiltro = document.getElementById('filtro-subcategoria-div');
            const listaProductos = document.getElementById('vinculacion-productos-lista');

            // Mostrar filtro de subcategoria solo para bebidas
            divFiltro.style.display = tipo === 'bebida' ? 'block' : 'none';

            // Filtrar productos segun tipo y subcategoria
            let productosFiltrados = todosLosProductos.filter(p => {
                if (tipo === 'bebida') {
                    return p.categoria_nombre && p.categoria_nombre.toLowerCase().includes('bebida');
                } else if (tipo === 'adicional') {
                    return p.categoria_nombre && p.categoria_nombre.toLowerCase().includes('adicion');
                }
                return true; // complemento muestra todos
            });

            // Filtrar por subcategoria si es bebida
            if (tipo === 'bebida' && filtroSubcategoria) {
                productosFiltrados = productosFiltrados.filter(p =>
                    p.tipo_bebida && p.tipo_bebida.toLowerCase() === filtroSubcategoria.toLowerCase()
                );
            }

            // Renderizar checkboxes
            if (productosFiltrados.length === 0) {
                listaProductos.innerHTML = '<p class="text-gray-400 text-sm">No hay productos disponibles</p>';
            } else {
                listaProductos.innerHTML = productosFiltrados.map(p => `
                    <label class="flex items-center p-2 hover:bg-slate-600 rounded cursor-pointer">
                        <input type="checkbox" value="${p.id}" class="mr-3 w-4 h-4 vinculacion-checkbox">
                        <span class="flex-1">${p.nombre}</span>
                        <span class="text-xs text-gray-400">${p.categoria_nombre}${p.tipo_bebida ? ' - ' + p.tipo_bebida : ''}</span>
                    </label>
                `).join('');
            }
        }

        async function crearVinculacionesMultiples() {
            const productoPrincipal = document.getElementById('vinculacion-producto-principal').value;
            const productosVinculados = Array.from(document.querySelectorAll('.vinculacion-checkbox:checked')).map(cb => cb.value);
            const tipo = document.getElementById('vinculacion-tipo').value;
            const obligatorio = document.getElementById('vinculacion-obligatorio').checked;
            const precio = parseFloat(document.getElementById('vinculacion-precio').value) || 0;

            if (!productoPrincipal) {
                mostrarNotificacion('Selecciona un producto principal', 'warning');
                return;
            }

            if (productosVinculados.length === 0) {
                mostrarNotificacion('Selecciona al menos un producto para vincular', 'warning');
                return;
            }

            if (productosVinculados.includes(productoPrincipal)) {
                mostrarNotificacion('No puedes vincular un producto consigo mismo', 'warning');
                return;
            }

            try {
                let exitosas = 0;
                let fallidas = 0;

                // Crear vinculaciones en paralelo
                const promesas = productosVinculados.map(async (productoVinculado) => {
                    try {
                        const response = await fetch(`${API_BASE_URL}/api/productos/${productoPrincipal}/vinculaciones`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                producto_vinculado_id: productoVinculado,
                                tipo_vinculacion: tipo,
                                obligatorio: obligatorio,
                                precio_adicional: precio
                            })
                        });

                        if (response.ok) {
                            exitosas++;
                        } else {
                            fallidas++;
                        }
                    } catch (error) {
                        fallidas++;
                    }
                });

                await Promise.all(promesas);

                if (exitosas > 0) {
                    mostrarNotificacion(`${exitosas} vinculacion(es) creada(s) exitosamente${fallidas > 0 ? `, ${fallidas} fallida(s)` : ''}`, 'success');
                    cargarVinculaciones();

                    // Limpiar formulario
                    document.getElementById('vinculacion-producto-principal').value = '';
                    document.querySelectorAll('.vinculacion-checkbox').forEach(cb => cb.checked = false);
                    document.getElementById('vinculacion-tipo').value = 'bebida';
                    document.getElementById('vinculacion-obligatorio').checked = false;
                    document.getElementById('vinculacion-precio').value = '';
                    filtrarProductosVinculados();
                } else {
                    mostrarNotificacion('Error al crear vinculaciones', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al crear vinculaciones', 'error');
            }
        }

        async function eliminarVinculacion(vinculacionId) {
            if (!confirm('Â¿Estas seguro de eliminar esta vinculacion?')) {
                return;
            }

            try {
                const deleteResponse = await fetch(`${API_BASE_URL}/api/productos/vinculaciones/${vinculacionId}`, {
                    method: 'DELETE'
                });

                if (deleteResponse.ok) {
                    mostrarNotificacion('Vinculacion eliminada exitosamente', 'success');
                    cargarVinculaciones();
                } else {
                    const result = await deleteResponse.json();
                    mostrarNotificacion(result.error || 'Error al eliminar vinculacion', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al eliminar vinculacion', 'error');
            }
        }

        function abrirModalVinculacion() {
            // Por ahora solo enfocamos en la seccion de creacion rapida
            document.getElementById('vinculacion-producto-principal').focus();
            mostrarNotificacion('Usa el formulario de creacion rapida para agregar vinculaciones', 'info');
        }

        // ==================== CONFIGURACIÃ©â€œN ====================
        // Las funciones de gestion de precios por zona estan en precios-zona.js

        async function cargarPrecioDomicilio() {
            // Esta funcion ahora es manejada por el sistema de precios por zona
            // Ver precios-zona.js: cargarConfiguracion() y cargarZonasPrecios()
            console.log('✅ Sistema de precios por zona cargado');
        }

        async function actualizarPrecioDomicilio() {
            // Funcion legacy - el sistema ahora usa precios por zona
            // Ver precios-zona.js: guardarConfiguracion()
            console.warn('⚠️ Esta funcion es obsoleta. Usar el nuevo sistema de precios por zona.');
            showNotification('Por favor usa la nueva seccion de Configuracion de Domicilios', 'info');
        }

        // Funcion auxiliar para mantener compatibilidad (no hace nada real ahora)
        async function actualizarPrecioDomicilioLegacy() {
            const nuevoPrecio = parseFloat(document.getElementById('nuevo-precio-domicilio')?.value);

            if (isNaN(nuevoPrecio) || nuevoPrecio < 0) {
                showNotification('Por favor ingresa un precio valido', 'error');
                return;
            }

            try {
                // Actualizar tambien en el frontend publico (si esta abierto)
                // Buscar todas las ventanas/frames que podrian tener el frontend publico
                const frames = window.parent.frames;
                for (let i = 0; i < frames.length; i++) {
                    try {
                        frames[i].postMessage({
                            type: 'actualizar_precio_domicilio',
                            precio: nuevoPrecio
                        }, '*');
                    } catch (e) {
                        // Ignorar errores de cross-origin
                    }
                }

                // Tambien intentar con window.parent directamente
                if (window.parent && window.parent !== window) {
                    try {
                        window.parent.postMessage({
                            type: 'actualizar_precio_domicilio',
                            precio: nuevoPrecio
                        }, '*');
                    } catch (e) {
                        // Ignorar errores de cross-origin
                    }
                }

                // Crear un evento personalizado para comunicar con otras instancias
                const eventoPrecio = new CustomEvent('precioDomicilioActualizado', {
                    detail: { precio: nuevoPrecio }
                });
                window.dispatchEvent(eventoPrecio);

                // Intentar con localStorage como respaldo (si estan en la misma origin)
                try {
                    localStorage.setItem('precio_domicilio', nuevoPrecio.toString());
                } catch (e) {
                    // Ignorar si localStorage no esta disponible
                }

                mostrarNotificacion('Precio de domicilio actualizado exitosamente', 'success');
                document.getElementById('nuevo-precio-domicilio').value = nuevoPrecio;
            } catch (error) {
                console.error('Error actualizando precio:', error);
                mostrarNotificacion('Error al actualizar precio', 'error');
            }
        }

        function formatPrice(price) {
            const numPrice = typeof price === 'string' ? parseFloat(price) : price;
            return Math.round(numPrice).toLocaleString('es-CO');
        }
        // ============= SISTEMA DE CAJA =============

        function inicializarEstadoCaja() {
            const cajaStart = localStorage.getItem('cajaSesionStart');
            console.log('Verificando estado de caja. Fecha inicio:', cajaStart);

            const btnAbrir = document.getElementById('btn-abrir-caja');
            const btnCerrar = document.getElementById('btn-cerrar-caja');
            const estadoInfo = document.getElementById('caja-info');
            const usuarioOpen = localStorage.getItem('cajaUsuario');

            // Asegurar estado inicial (ocultar ambos)
            if (btnAbrir) btnAbrir.style.display = 'none';
            if (btnCerrar) btnCerrar.style.display = 'none';

            if (cajaStart && cajaStart !== 'undefined' && cajaStart !== 'null') {
                // CAJA ABIERTA
                console.log('Estado detectado: ABIERTA');
                if (btnCerrar) btnCerrar.style.display = 'block'; // Mostrar Cerrar
                if (estadoInfo) {
                    estadoInfo.className = 'text-lg mb-2 p-2 bg-green-900 bg-opacity-50 rounded border border-green-500';
                    estadoInfo.innerHTML = `
                        <div class="flex items-center">
                            <span class="text-3xl mr-2">🟢</span>
                            <div>
                                <span class="text-green-400 font-bold text-xl">CAJA ABIERTA</span>
                                <div class="text-xs text-gray-300">Desde: ${new Date(cajaStart).toLocaleTimeString()}</div>
                                <div class="text-xs text-gray-300">Usuario: ${usuarioOpen || 'Admin'}</div>
                            </div>
                        </div>`;
                }
            } else {
                // CAJA CERRADA
                console.log('Estado detectado: CERRADA');
                // Limpieza preventiva
                ['cajaSesionStart', 'cajaStartTime', 'cajaUsuario'].forEach(k => localStorage.removeItem(k));

                if (btnAbrir) btnAbrir.style.display = 'block'; // Mostrar Abrir
                if (estadoInfo) {
                    estadoInfo.className = 'text-lg mb-2 p-2 bg-red-900 bg-opacity-50 rounded border border-red-500';
                    estadoInfo.innerHTML = `
                        <div class="flex items-center">
                            <span class="text-3xl mr-2">🔴</span>
                            <div>
                                <span class="text-red-400 font-bold text-xl">CAJA CERRADA</span>
                                <div class="text-xs text-gray-300">Sin sesión activa</div>
                            </div>
                        </div>`;
                }
            }
        }

        // Sincronizar pestañas
        window.addEventListener('storage', (e) => {
            if (e.key === 'cajaSesionStart') {
                console.log('Detectado cambio de sesión en otra pestaña');
                inicializarEstadoCaja();
            }
        });

        function mostrarModalAbrirCaja() {
            const modal = document.getElementById('modal-abrir-caja');
            modal.classList.add('show');
            document.getElementById('monto-inicial-caja').value = '';
            document.getElementById('usuario-apertura').value = '';
        }

        function cerrarModalAbrirCaja() {
            document.getElementById('modal-abrir-caja').classList.remove('show');
        }

        function abrirCaja() {
            const usuario = document.getElementById('usuario-apertura').value || 'Admin';
            const monto = document.getElementById('monto-inicial-caja').value || 0;

            // Guardar inicio de sesion (clave compartida con app.js)
            const startTime = new Date().toISOString();
            localStorage.setItem('cajaSesionStart', startTime);
            localStorage.setItem('cajaUsuario', usuario);
            localStorage.setItem('cajaMontoInicial', monto);

            cerrarModalAbrirCaja();
            inicializarEstadoCaja();
            showNotification('Caja abierta exitosamente. Los pedidos se filtrarán a partir de ahora.', 'success');
        }

        function cerrarCaja() {
            if (confirm('¿Seguro que deseas CERRAR CAJA? Esto finalizará la sesion actual.')) {
                // Calcular total ventas (mock por ahora)
                const ventas = document.getElementById('dashboard-ventas-dia')?.innerText || '$0';

                // Limpieza Profunda de Sesión
                console.log('Cerrando caja y limpiando sesión...');
                localStorage.removeItem('cajaSesionStart');
                localStorage.removeItem('cajaUsuario');
                localStorage.removeItem('cajaMontoInicial');
                localStorage.removeItem('cajaStartTime'); // Limpiar clave legacy por seguridad

                // Forzar UI a estado cerrado
                inicializarEstadoCaja();

                alert(`Caja Cerrada Exitosamente.\nVentas registradas: ${ventas}`);
                console.log('Caja cerrada. Claves eliminadas.');
            }
        }

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            inicializarEstadoCaja();
            // ... resto de inicializaciones ...
        });

        // ... (resto de funciones existentes)
    </script>
</body>

</html>